{
  "name": "Smart License Usage Analyzer 2",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -3376,
        -1920
      ],
      "id": "c6251667-4918-4c51-b593-8256200970eb",
      "name": "Webhook - Telegram Bot",
      "webhookId": "555c8ccf-741d-46c2-9d44-c92899e63274",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6a0aebe7-3cc2-436b-9e72-97a6755e7829",
                    "leftValue": "={{ $('Edit Fields').item.json.text }}",
                    "rightValue": "/",
                    "operator": {
                      "type": "string",
                      "operation": "notContains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "4 - User Input"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "06f8b71a-a419-4fc2-8746-c0569ad7bfbd",
                    "leftValue": "={{ $('Edit Fields').item.json.text }}",
                    "rightValue": "=/createvm",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "1 - –°–æ–∑–¥–∞–Ω–∏–µ –í–ú"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8104b393-31e7-47be-b040-daa9528965e5",
                    "leftValue": "={{ $('Edit Fields').item.json.text }}",
                    "rightValue": "=^/(myresources|softwarecatalog|vmdetails)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "2 - –ü—Ä–æ—Å–º–æ—Ç—Ä (–æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–µ)"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8342202e-e017-4985-b2dc-c193b6942c3b",
                    "leftValue": "={{ $('Edit Fields').item.json.text }}",
                    "rightValue": "=^/(optimize|checkidle)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "3 - –ê–Ω–∞–ª–∏–∑ (–æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–µ)"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9c276292-995f-4620-8090-129e10a08a83",
                    "leftValue": "={{ $('Edit Fields').item.json.text }}",
                    "rightValue": "=/help",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "5 - –ü–æ–º–æ—â—å"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "–û–±—Ä–∞–±–æ—Ç—á–∏–∫ Fallback: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -896,
        -1792
      ],
      "id": "762e56ef-bccf-4d38-aaae-c636aa41e21c",
      "name": "Command Router",
      "retryOnFail": false,
      "executeOnce": false,
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "672b5415-5aae-4b51-a0d1-72f0785edaf7",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2256,
        -2880
      ],
      "id": "194596e1-c58d-4983-a075-33e815f34c67",
      "name": "User Registered?"
    },
    {
      "parameters": {
        "jsCode": "// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nconst userNode = $('Get User for VM Creation');\nif (!userNode || userNode.all().length === 0) {\n  return [{\n    json: {\n      canCreate: false,\n      currentCount: 0,\n      limit: 0,\n      error: 'User not found',\n      chat_id: $('Edit Fields').item.json.chat_id\n    },\n    pairedItem: 0\n  }];\n}\n\nconst userData = userNode.first().json;\nconst allVMs = $input.all();\n\n// –°—á–∏—Ç–∞–µ–º –í–ú —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nconst userVMs = allVMs.filter(vm => \n  parseInt(vm.json.user_id) === parseInt(userData.user_id)\n);\n\nconst currentCount = userVMs.length;\nconst limit = parseInt(userData.license_limit) || 0;\n\nreturn [{\n  json: {\n    canCreate: currentCount < limit,\n    currentCount,\n    limit,\n    user_id: userData.user_id,\n    telegram_id: userData.telegram_id,\n    username: userData.username,\n    chat_id: $('Edit Fields').item.json.chat_id\n  },\n  pairedItem: 0\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2816,
        -2880
      ],
      "id": "bc5dda3a-cf37-41f6-a1d1-d93088b27f42",
      "name": "Check License Limit",
      "retryOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "243b271c-bcaa-49e1-9711-4117e72a2b0d",
              "leftValue": "={{ $json.canCreate }}",
              "rightValue": "=true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3056,
        -2880
      ],
      "id": "9a2d9155-9b3b-44da-a693-a51cb5f47bca",
      "name": "Can Create VM?"
    },
    {
      "parameters": {
        "jsCode": "// --- 1. –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---\nlet userData = {\n  user_id: null,\n  telegram_id: $('Webhook - Telegram Bot').first().json.message.from.id,\n  username: $('Webhook - Telegram Bot').first().json.message.from.first_name\n};\n\n// –ü–æ–ø—ã—Ç–∫–∞ 1: –î–∞–Ω–Ω—ã–µ –ø—Ä–∏—à–ª–∏ –Ω–∞ –≤—Ö–æ–¥ (–µ—Å–ª–∏ –ø—Ä–æ–±—Ä–æ—à–µ–Ω—ã —á–µ—Ä–µ–∑ State Router)\n// State Router –æ–±—ã—á–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç item –¥–∞–ª—å—à–µ. –ü—Ä–æ–≤–µ—Ä–∏–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É–∑–ª–∞.\n// –ù–æ —Ç–∞–∫ –∫–∞–∫ –∑–¥–µ—Å—å –Ω–∞ –≤—Ö–æ–¥ –ø—Ä–∏—Ö–æ–¥–∏—Ç –ö–∞—Ç–∞–ª–æ–≥ –ü–û (–º–∞—Å—Å–∏–≤ –∏–∑ 8 —ç–ª–µ–º–µ–Ω—Ç–æ–≤),\n// –º—ã –Ω–µ –º–æ–∂–µ–º –∏—Å–∫–∞—Ç—å user_id –≤ $input.all().\n// –ù–ê–ú –ù–£–ñ–ù–û –ù–ê–ô–¢–ò –î–ê–ù–ù–´–ï –í –ü–†–ï–î–´–î–£–©–ò–• –£–ó–õ–ê–•.\n\ntry {\n  // –ò—â–µ–º –≤ Parse State (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —á–µ—Ä–µ–∑ –º–µ–Ω—é)\n  // –ò–º—è —É–∑–ª–∞ –¥–æ–ª–∂–Ω–æ —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –≤–∞—à–∏–º (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ!)\n  const stateNode = $('Parse State').first(); \n  \n  if (stateNode && stateNode.json && stateNode.json.user_id) {\n     userData.user_id = stateNode.json.user_id;\n     console.log(\"User ID –Ω–∞–π–¥–µ–Ω –≤ Parse State: \" + userData.user_id);\n  } \n  \n  // –ü–æ–ø—ã—Ç–∫–∞ 2: –ï—Å–ª–∏ —à–ª–∏ –ø—Ä—è–º–æ–π –¥–æ—Ä–æ–≥–æ–π (–Ω–µ —á–µ—Ä–µ–∑ Router), –∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è\n  if (!userData.user_id) {\n     const directUserNode = $('Get User for VM Creation').first();\n     if (directUserNode && directUserNode.json && directUserNode.json.user_id) {\n        userData.user_id = directUserNode.json.user_id;\n        console.log(\"User ID –Ω–∞–π–¥–µ–Ω –≤ Get User: \" + userData.user_id);\n     }\n  }\n\n} catch (e) {\n  console.log(\"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ ID: \" + e.message);\n}\n\n// –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê\n// –ï—Å–ª–∏ user_id –≤—Å—ë –µ—â–µ –Ω–µ—Ç –∏–ª–∏ –æ–Ω —Ä–∞–≤–µ–Ω telegram_id (—á—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ)\n// –ù–æ –¥–ª—è –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º—ã user_id (serial) –∏ telegram_id (bigint) –æ–±—ã—á–Ω–æ —Ä–∞–∑–Ω—ã–µ.\nif (!userData.user_id) {\n   throw new Error(\"CRITICAL: –ù–µ –Ω–∞–π–¥–µ–Ω User ID –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ Redis —Å–æ–¥–µ—Ä–∂–∏—Ç user_id.\");\n}\n\n// ... –¥–∞–ª–µ–µ –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞, –∫–∞—Ç–∞–ª–æ–≥ –∏ —Ç.–¥.)\n\n\n// --- 2. –û–ë–†–ê–ë–û–¢–ö–ê –í–í–û–î–ê (–í–´–ë–û–† –ü–û) ---\nlet userInput = \"\";\ntry {\n  // –ë–µ—Ä–µ–º —Ç–µ–∫—Å—Ç –ø—Ä—è–º–æ –∏–∑ –≤–µ–±—Ö—É–∫–∞, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç Edit Fields\n  userInput = $('Webhook - Telegram Bot').first().json.message.text;\n} catch (e) {\n  userInput = \"\";\n}\n\n// –£–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—É, –µ—Å–ª–∏ –µ—Å—Ç—å\nconst cleanInput = userInput.replace(/^\\/createvm\\s*/i, '').trim();\nlet selectedSoftwareIds = [];\n\nif (cleanInput) {\n  selectedSoftwareIds = cleanInput.split(',')\n    .map(id => parseInt(id.trim()))\n    .filter(id => !isNaN(id));\n}\n\nif (selectedSoftwareIds.length === 0) {\n  throw new Error('–ù–µ —É–∫–∞–∑–∞–Ω–æ –ü–û! –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1, 2)');\n}\n\n// --- 3. –†–ê–ë–û–¢–ê –° –ö–ê–¢–ê–õ–û–ì–û–ú –ü–û ---\n// –ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–∏—à–µ–ª –ù–ê –í–•–û–î —ç—Ç–æ–º—É —É–∑–ª—É (—Å–º. –≤–∞—à Input data)\n// –ú—ã –º–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å $input.all()\nconst softwareCatalog = $input.all().map(item => item.json);\n\nlet monthlyCost = 0;\nconst installedSoftwareNames = [];\n\nselectedSoftwareIds.forEach(id => {\n  const sw = softwareCatalog.find(s => parseInt(s.software_id) === id);\n  if (sw) {\n    // –ü–∞—Ä—Å–∏–º —Ü–µ–Ω—É, –µ—Å–ª–∏ –æ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ \"3000.00\"\n    const price = parseFloat(sw.cost_per_month) || 0;\n    monthlyCost += price;\n    installedSoftwareNames.push(sw.name);\n  }\n});\n\n// --- 4. –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–ê–ù–ù–´–• –í–ú ---\nconst timestamp = Date.now();\nconst random = Math.floor(Math.random() * 1000);\n// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID, –∫–æ—Ç–æ—Ä—ã–π –≤–ª–µ–∑–µ—Ç –≤ integer (–µ—Å–ª–∏ –≤ –±–∞–∑–µ int4)\nconst newVmId = Math.floor(timestamp / 1000) + random; \n\nconst shortTimestamp = timestamp.toString().slice(-6);\nconst softwareAbbr = installedSoftwareNames.length > 0 \n  ? installedSoftwareNames[0].substring(0, 3).toUpperCase() \n  : 'SYS';\n\nconst vmName = `VM-${userData.user_id}-${shortTimestamp}-${softwareAbbr}`;\n\n// –°–∏–º—É–ª—è—Ü–∏—è –º–µ—Ç—Ä–∏–∫\nconst usageHours = Math.floor(Math.random() * 36) + 5;\nconst cpuUsage = Math.floor(Math.random() * 70) + 15;\nconst ramUsage = Math.floor(Math.random() * 60) + 30;\n\nlet status = 'active';\nif (usageHours < 5) status = 'stopped';\nelse if (usageHours < 20) status = 'idle';\n\nconst now = new Date();\nconst createdAt = now.toISOString().split('T')[0];\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç\nreturn {\n  json: {\n    vm_id: newVmId,\n    user_id: userData.user_id,\n    vm_name: vmName,\n    software_installed: selectedSoftwareIds.join(','),\n    created_at: createdAt,\n    last_active: createdAt,\n    cpu_usage_avg: cpuUsage,\n    ram_usage_avg: ramUsage,\n    status: status,\n    monthly_cost: monthlyCost,\n    usage_hours_week: usageHours,\n    inactivity_days: 0,\n    alert_sent: false,\n    installed_software_names: installedSoftwareNames.join(', '),\n    chat_id: $('Webhook - Telegram Bot').first().json.message.chat.id\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3056,
        -2560
      ],
      "id": "d824493a-e444-4b75-98e6-df0a0cae263b",
      "name": "Create VM with Software"
    },
    {
      "parameters": {
        "chatId": "={{ $('Create VM with Software').item.json.chat_id }}",
        "text": "=‚úÖ –í–ú —Å–æ–∑–¥–∞–Ω–∞!\n\nüì¶ –ù–∞–∑–≤–∞–Ω–∏–µ –í–ò: {{ $json.vm_name }}\nüíø –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –ü–û: {{ $('Create VM with Software').item.json.installed_software_names }}\nüìä –°—Ç–∞—Ç—É—Å: {{ $json.status }}\nüí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {{ $json.monthly_cost }} ‚ÇΩ/–º–µ—Å\n\n‚öôÔ∏è –†–µ—Å—É—Ä—Å—ã:\n‚Ä¢ CPU: ____ %\n‚Ä¢ RAM: ____ %\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ____ —á/–Ω–µ–¥–µ–ª—é\n\n–ö–æ–º–∞–Ω–¥—ã:\nüì± /myresources ‚Äî –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã\nüîç /vmdetails {{ $json.vm_id }} ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3568,
        -2560
      ],
      "id": "71f24402-c0be-4470-b215-d70cafd1ef1a",
      "name": "Send: VM Created",
      "webhookId": "ee05d908-8316-461b-b370-6f150dbf510b",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "content": "## –û–±—Ä–∞–±–æ—Ç—á–∏–∫: –°–æ–∑–¥–∞–Ω–∏–µ –í–ú (/create_vm)\n\n1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `/createvm`, —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ø–∞–¥–∞–µ—Ç –∏–∑ `Webhook - Telegram Bot` –≤ `Edit Fields`\n1. –ó–∞—Ç–µ–º —á–µ—Ä–µ–∑ `Command Router` –≤ –≤–µ—Ç–∫—É ¬´**1 - –°–æ–∑–¥–∞–Ω–∏–µ –í–ú**¬ª.\n1. –£–∑–µ–ª `Get User for VM Creation` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, –∞ `User Registered?` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –æ–Ω\n1. –ü—Ä–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `Send: Not Registered`.\n1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, `Get Existing VMs for User` –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –µ–≥–æ –í–ú, –∑–∞—Ç–µ–º `Check License Limit` —Å—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –í–ú –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –ª–∏–º–∏—Ç–æ–º –ª–∏—Ü–µ–Ω–∑–∏–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É—Ö–æ–¥–∏—Ç –≤ `Can Create VM?`.\n1. –í `Can Create VM?` –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –º–µ–Ω—é –ü–û —á–µ—Ä–µ–∑ `Prepare Software Menu` (–¥–∞–ª–µ–µ ‚Äî —É–∑–µ–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ —ç—Ç–æ–≥–æ –º–µ–Ω—é –≤ Telegram), –∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `Send: Limit Exceeded`.\n1. –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –ü–û, –∫–æ–¥–æ–≤—ã–π —É–∑–µ–ª `Create VM with Software` —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–æ–≤–æ–π –í–ú –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å, `Save VM to Sheet` –¥–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É **Virtual_Machines**\n1. `Send: VM Created` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Telegram –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–æ–∑–¥–∞–Ω–Ω–æ–π –í–ú –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–∏–º –∫–æ–º–∞–Ω–¥–∞–º.\n",
        "height": 1152,
        "width": 2288,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1840,
        -3360
      ],
      "typeVersion": 1,
      "id": "ee6b75ec-84c2-423c-b32b-44f68811793a",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "jsCode": "const userData = $('Get User').first().json;\nconst allVMs = $('Get VMs for Resources').all();\n\n// –§–∏–ª—å—Ç—Ä—É–µ–º –í–ú —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nconst userVMs = allVMs.filter(vm => vm.json.user_id === userData.user_id);\n\nlet totalCost = 0;\nlet activeCount = 0;\nlet idleCount = 0;\nlet stoppedCount = 0;\nlet activeCost = 0;\nlet idleCost = 0;\nlet stoppedCost = 0;\n\nuserVMs.forEach(vm => {\n  totalCost += vm.json.monthly_cost;\n  \n  if (vm.json.status === 'active') {\n    activeCount++;\n    activeCost += vm.json.monthly_cost;\n  } else if (vm.json.status === 'idle') {\n    idleCount++;\n    idleCost += vm.json.monthly_cost;\n  } else {\n    stoppedCount++;\n    stoppedCost += vm.json.monthly_cost;\n  }\n});\n\nconst licenseMap = {\n  basic: { name: 'Basic', limit: 3, cost: 5000 },\n  standard: { name: 'Standard', limit: 10, cost: 15000 },\n  premium: { name: 'Premium', limit: 50, cost: 40000 }\n};\n\nconst license = licenseMap[userData.license_type];\n\nlet message = `üìä –í–∞—à–∏ —Ä–µ—Å—É—Ä—Å—ã\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\nmessage += `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userData.username}\\n`;\nmessage += `üíº –õ–∏—Ü–µ–Ω–∑–∏—è: ${license.name} (${userVMs.length}/${license.limit} –í–ú)\\n`;\nmessage += `üí∞ –ó–∞—Ç—Ä–∞—Ç—ã: ${totalCost.toLocaleString()}‚ÇΩ/–º–µ—Å\\n\\n`;\n\nmessage += `üñ•Ô∏è –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã:\\n`;\nmessage += `‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö: ${activeCount} (${activeCost.toLocaleString()}‚ÇΩ)\\n`;\nmessage += `‚ö†Ô∏è –ü—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏—Ö: ${idleCount} (${idleCost.toLocaleString()}‚ÇΩ)\\n`;\nmessage += `‚ùå –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö: ${stoppedCount} (${stoppedCost.toLocaleString()}‚ÇΩ)\\n\\n`;\n\n// –î–û–ë–ê–í–õ–Ø–ï–ú –°–ü–ò–°–û–ö –í–ú\nif (userVMs.length > 0) {\n  message += `üìã –°–ø–∏—Å–æ–∫ –í–ú:\\n`;\n  userVMs.forEach((vm, index) => {\n    const statusIcon = vm.json.status === 'active' ? '‚úÖ' : \n                       vm.json.status === 'idle' ? '‚ö†Ô∏è' : '‚ùå';\n    message += `${index + 1}. ${statusIcon} ${vm.json.vm_name}\\n`;\n    message += `   üíø –ü–û: ${vm.json.software_installed}\\n`;\n    message += `   üí∞ ${vm.json.monthly_cost.toLocaleString()}‚ÇΩ/–º–µ—Å\\n`;\n    message += `   üîç /vmdetails ${vm.json.vm_id}\\n\\n`;\n  });\n}\n\nmessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\nmessage += `üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\\n`;\nmessage += `/optimize - –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\\n`;\nmessage += `/checkidle - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏–µ –í–ú`;\n\nreturn {\n  json: {\n    message,\n    chat_id: $('Webhook - Telegram Bot').item.json.message.chat.id\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2048,
        -1104
      ],
      "id": "d6ec69c9-bbad-437d-8169-4ac1407613bd",
      "name": "Calculate Summary"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2256,
        -1104
      ],
      "id": "0870e412-ba63-4e79-9a91-f1b8c43c5b29",
      "name": "Send: Resources Summary",
      "webhookId": "27f16c26-00f4-440b-8b19-5fe8c1f385e5",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "content": "## –û–±—Ä–∞–±–æ—Ç—á–∏–∫: –ú–æ–∏ —Ä–µ—Å—É—Ä—Å—ã (/my_resources)\n\n1. –ö–æ–º–∞–Ω–¥–∞ `/myresources` –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `Command Router` –≤ –≤–µ—Ç–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ—Å—É—Ä—Å–æ–≤, –≥–¥–µ —É–∑–µ–ª `Get User for Resources` –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞ `Get VMs for Resources` ‚Äî –≤—Å–µ –µ–≥–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã.\n1. –ö–æ–¥–æ–≤—ã–π —É–∑–µ–ª `Calculate Summary` –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –í–ú: —Å—á–∏—Ç–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (**active**/**idle**/**stopped**), –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç —Å –∫—Ä–∞—Ç–∫–∏–º —Å–ø–∏—Å–∫–æ–º –í–ú –∏ –∫–æ–º–∞–Ω–¥–∞–º–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.\n1. –£–∑–µ–ª `Send: Resources Summary` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —ç—Ç–æ—Ç –æ—Ç—á—ë—Ç –≤ Telegram, —á—Ç–æ–±—ã –æ–Ω –≤–∏–¥–µ–ª –∫–∞—Ä—Ç–∏–Ω—É –ø–æ —Å–≤–æ–∏–º —Ä–µ—Å—É—Ä—Å–∞–º –∏ –º–æ–≥ –ø–µ—Ä–µ–π—Ç–∏ –∫ `/vmdetails`, `/optimize` –∏–ª–∏ `/checkidle`.",
        "height": 688,
        "width": 1568,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1008,
        -1344
      ],
      "typeVersion": 1,
      "id": "1f4afba8-fffe-4981-9857-5b999b0776a1",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## –û–±—Ä–∞–±–æ—Ç—á–∏–∫: AI-–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (/optimize)\n\n1. –ü—Ä–∏ –∫–æ–º–∞–Ω–¥–µ` /optimize` Command Router –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≤–µ—Ç–∫—É –∞–Ω–∞–ª–∏–∑–∞, –≥–¥–µ `Get User for Optimize` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ –ª–∏—Ü–µ–Ω–∑–∏–∏, –∞ `Get VMs for Optimize` ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –µ–≥–æ –í–ú.\n1. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤ workflow —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∫–∞—Ç–∞–ª–æ–≥ –ü–û (—á–µ—Ä–µ–∑ Load Software Catalog), –∏ —É–∑–µ–ª `Build Optimization Prompt` –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –í–ú, –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏ –ü–û —Å–æ–±–∏—Ä–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM.\n1. –£–∑–µ–ª OpenRouter Chat Model (—á–µ—Ä–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É–∑–µ–ª `AI Optimization Analysis`) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç –ø—Ä–æ–º–ø—Ç, `Add Footer to Message` –¥–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏\n1.  `Send: AI Recommendations` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ —É–¥–∞–ª–µ–Ω–∏—é, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é –í–ú –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ª–∏—Ü–µ–Ω–∑–∏–∏.",
        "height": 592,
        "width": 2000,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2656,
        -656
      ],
      "typeVersion": 1,
      "id": "436b1b9d-e5eb-48e5-9bcd-04ed2f9a9dd5",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nconst userData = $('Get User for Optimize').first().json;\n\n// –ü–æ–ª—É—á–∞–µ–º –í–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nconst allVMs = $('Get VMs for Optimize').all();\n\n// –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ –ü–û\nconst software = $input.all();\n\n// –§–∏–ª—å—Ç—Ä—É–µ–º –í–ú —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nconst userVMs = allVMs.filter(vm => vm.json.user_id === userData.user_id);\n\n// –°–æ–∑–¥–∞—ë–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ü–û\nconst softwareMap = {};\nsoftware.forEach(sw => {\n  softwareMap[sw.json.software_id] = sw.json;\n});\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π –í–ú\nlet vmDescriptions = '';\nuserVMs.forEach((vm, index) => {\n  // –ë–ï–ó–û–ü–ê–°–ù–û –ø–∞—Ä—Å–∏–º software_installed (–º–æ–∂–µ—Ç –±—ã—Ç—å —á–∏—Å–ª–æ–º –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π)\n  let softwareIds = [];\n  if (vm.json.software_installed) {\n    const softwareStr = String(vm.json.software_installed);\n    softwareIds = softwareStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));\n  }\n  \n  const softwareNames = softwareIds.map(id => \n    softwareMap[id] ? softwareMap[id].name : 'Unknown'\n  ).join(', ');\n  \n  vmDescriptions += `${index + 1}. ${vm.json.vm_name}\\n`;\n  vmDescriptions += `   –ü–û: ${softwareNames || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'}\\n`;\n  vmDescriptions += `   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ${vm.json.usage_hours_week || 0} —á–∞—Å–æ–≤/–Ω–µ–¥–µ–ª—é\\n`;\n  vmDescriptions += `   CPU: ${vm.json.cpu_usage_avg || 0}%, RAM: ${vm.json.ram_usage_avg || 0}%\\n`;\n  vmDescriptions += `   –ü—Ä–æ—Å—Ç–æ–π: ${vm.json.inactivity_days || 0} –¥–Ω–µ–π\\n`;\n  vmDescriptions += `   –°—Ç–æ–∏–º–æ—Å—Ç—å: ${vm.json.monthly_cost || 0}‚ÇΩ/–º–µ—Å\\n`;\n  vmDescriptions += `   –°—Ç–∞—Ç—É—Å: ${vm.json.status}\\n\\n`;\n});\n\n// –ï—Å–ª–∏ –Ω–µ—Ç –í–ú\nif (userVMs.length === 0) {\n  return {\n    json: {\n      error: true,\n      message: '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\\n\\n–°–æ–∑–¥–∞–π—Ç–µ –í–ú –∫–æ–º–∞–Ω–¥–æ–π /createvm',\n      chat_id: $('Edit Fields').first().json.chat_id\n    }\n  };\n}\n\nconst totalCost = userVMs.reduce((sum, vm) => sum + (vm.json.monthly_cost || 0), 0);\n\nconst prompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω –∏ –¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.\n\nüìä –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n- –õ–∏—Ü–µ–Ω–∑–∏—è: ${userData.license_type} (${userVMs.length}/${userData.license_limit} –í–ú)\n- –¢–µ–∫—É—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã: ${totalCost}‚ÇΩ/–º–µ—Å\n\nüñ•Ô∏è –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã:\n${vmDescriptions}\n\nüìã –ó–∞–¥–∞—á–∏:\n1. –û–ø—Ä–µ–¥–µ–ª–∏ –í–ú –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–∫—Ä–∏—Ç–µ—Ä–∏–π: –ø—Ä–æ—Å—Ç–æ–π >14 –¥–Ω–µ–π –ò–õ–ò usage_hours_week <5)\n2. –ù–∞–π–¥–∏ –í–ú –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è (–∫—Ä–∏—Ç–µ—Ä–∏–π: –ø–æ—Ö–æ–∂–∏–π –Ω–∞–±–æ—Ä –ü–û –ò —Å—É–º–º–∞—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ CPU+RAM <140%)\n3. –û—Ü–µ–Ω–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –ª–∏—Ü–µ–Ω–∑–∏–∏:\n   - basic: 3 –í–ú, 5000‚ÇΩ/–º–µ—Å\n   - standard: 10 –í–ú, 15000‚ÇΩ/–º–µ—Å\n   - premium: 50 –í–ú, 40000‚ÇΩ/–º–µ—Å\n4. –†–∞—Å—Å—á–∏—Ç–∞–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é —ç–∫–æ–Ω–æ–º–∏—é\n\n–í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –°–¢–†–û–ì–û –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞, –≥–æ—Ç–æ–≤—ã–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram.`;\n\nreturn {\n  json: {\n    chatInput: prompt,\n    chat_id: $('Edit Fields').first().json.chat_id\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3536,
        -480
      ],
      "id": "b41246c9-33ee-4b8c-9c84-2827f1214e79",
      "name": "Build Optimization Prompt"
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 1000,
          "temperature": 0.7
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        3744,
        -272
      ],
      "id": "75e3c87b-96dc-4a06-91a5-7fdea3b8b61d",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "vTmXgtf5tUnqsJGf",
          "name": "OpenRouter posapr"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Edit Fields').first().json.telegram_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4384,
        -480
      ],
      "id": "7f8836ea-6f2f-4d62-8968-50408ad96f1a",
      "name": "Send: AI Recommendations",
      "webhookId": "735c4e5c-923d-4d62-a2d4-e31d28f70f42",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "content": "## –û–±—Ä–∞–±–æ—Ç—á–∏–∫: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Å—Ç–æ—è (/check_idle)\n\n1. –ö–æ–º–∞–Ω–¥–∞ `/checkidle` —Ç–∞–∫–∂–µ –ø–æ–ø–∞–¥–∞–µ—Ç —á–µ—Ä–µ–∑ Command Router –≤ –≤–µ—Ç–∫—É –∞–Ω–∞–ª–∏–∑–∞, –≥–¥–µ `Get User for Idle Check` –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n1. –£–∑–µ–ª `Get VMs for Idle Check` –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –≤—Å–µ –µ–≥–æ –í–ú —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ—Å—Ç–æ—è.\n1. –ö–æ–¥–æ–≤—ã–π —É–∑–µ–ª `Detect Idle VMs` –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –º–∞—à–∏–Ω—ã –ø–æ —É—Ä–æ–≤–Ω—è–º –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ (–∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏—á–µ—Å–∫–∏–π, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π, –≤—ã—Å–æ–∫–∏–π, —Å—Ä–µ–¥–Ω–∏–π, –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∏ —Ç.–¥.), —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é —ç–∫–æ–Ω–æ–º–∏—é –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç –ø–æ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ.\n1. –£–∑–µ–ª `Send: Idle Report` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —ç—Ç–æ—Ç –æ—Ç—á—ë—Ç –≤ Telegram, –≤–∫–ª—é—á–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –í–ú, –ø—Ä–æ—Å—Ç–æ—è–º –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–∏–º –¥–µ–π—Å—Ç–≤–∏—è–º (–≤ —Ç–æ–º —á–∏—Å–ª–µ —Å—Å—ã–ª–∫—É –Ω–∞ `/optimize`).\n",
        "height": 624,
        "width": 1568
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        992,
        -272
      ],
      "typeVersion": 1,
      "id": "67d68421-fc1b-4073-b529-410564f2dd59",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "jsCode": "const userData = $('Get User for Idle Check').first().json;\nconst allVMs = $('Get VMs for Idle Check').all();\n\nconst userVMs = allVMs.filter(vm => vm.json.user_id === userData.user_id);\n\n// –û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏\nconst catastrophic = []; // >90 –¥–Ω–µ–π, stopped —Å dataLoss –∏–ª–∏ failed\nconst critical = [];     // 30-90 –¥–Ω–µ–π –∏–ª–∏ stopped\nconst high = [];         // 14-30 –¥–Ω–µ–π –∏–ª–∏ idle —Å –Ω–∏–∑–∫–∏–º usage\nconst medium = [];       // 7-14 –¥–Ω–µ–π\nconst normal = [];       // 3-7 –¥–Ω–µ–π\nconst low = [];          // 1-3 –¥–Ω—è\nconst minimal = [];      // <1 –¥–Ω—è\n\n// –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –í–ú\nconst realTimeClassification = {\n  active: [],        // –¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è (active_session = true)\n  recent: [],        // <15 –º–∏–Ω—É—Ç (0.01 –¥–Ω—è)\n  today: [],         // <24 —á–∞—Å–∞ (<1 –¥–Ω—è)\n  thisWeek: [],      // <7 –¥–Ω–µ–π (—É–∂–µ –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö)\n};\n\n// –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—è\nconst now = new Date();\n\nuserVMs.forEach(vm => {\n  const vmData = vm.json;\n  const inactivity = vmData.inactivity_days;\n  const status = vmData.status;\n  const usage = vmData.usage_hours_week;\n  const lastActivity = vmData.last_activity_time ? new Date(vmData.last_activity_time) : null;\n  const hasActiveSession = vmData.active_session === true;\n  \n  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è –≤ —á–∞—Å–∞—Ö/–º–∏–Ω—É—Ç–∞—Ö\n  let exactInactivityHours = inactivity * 24;\n  if (lastActivity) {\n    exactInactivityHours = (now - lastActivity) / (1000 * 60 * 60);\n  }\n  \n  // –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏\n  if ((inactivity >= 90 && status !== 'active') || (status === 'stopped' && (vmData.data_loss === true || vmData.state === 'failed'))) {\n    catastrophic.push(vmData);\n  } else if (inactivity >= 30 || (status === 'stopped' && inactivity >= 14)) {\n    critical.push(vmData);\n  } else if (inactivity >= 14 || (status === 'idle' && usage < 5)) {\n    high.push(vmData);\n  } else if (inactivity >= 7) {\n    medium.push(vmData);\n  } else if (inactivity >= 3) {\n    normal.push(vmData);\n  } else if (inactivity >= 1) {\n    low.push(vmData);\n  } else {\n    minimal.push(vmData);\n  }\n  \n  // –î–µ—Ç–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –í–ú (—Ç–µ—Ö, —á—Ç–æ –≤ minimal)\n  if (inactivity < 1) {\n    if (hasActiveSession) {\n      realTimeClassification.active.push(vmData);\n    } else if (exactInactivityHours < 0.25) { // <15 –º–∏–Ω—É—Ç\n      realTimeClassification.recent.push(vmData);\n    } else if (exactInactivityHours < 1) { // <1 —á–∞—Å–∞\n      vmData.inactivity_hours = exactInactivityHours.toFixed(1);\n      realTimeClassification.today.push(vmData);\n    } else {\n      // –û—Å—Ç–∞–ª—å–Ω—ã–µ –í–ú —Å –ø—Ä–æ—Å—Ç–æ—è–º <1 –¥–Ω—è –æ—Å—Ç–∞—é—Ç—Å—è –≤ minimal\n    }\n  }\n});\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç\nlet message = `üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –í–ú\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\n\n// 1. –ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å\nif (catastrophic.length > 0) {\n  message += `‚õî –ö–ê–¢–ê–°–¢–†–û–§–ò–ß–ï–°–ö–ò–ô –£–†–û–í–ï–ù–¨ (${catastrophic.length}):\\n`;\n  catastrophic.forEach(vm => {\n    message += `‚î£‚îÅ ${vm.vm_name}\\n`;\n    message += `‚îÉ  ‚îî –ü—Ä–æ—Å—Ç–æ–π: ${vm.inactivity_days} –¥–Ω–µ–π\\n`;\n    message += `‚îÉ  ‚îî –°—Ç–∞—Ç—É—Å: ${vm.status}${vm.data_loss ? ' (–ü–û–¢–ï–†–Ø –î–ê–ù–ù–´–•!)' : ''}\\n`;\n    message += `‚îÉ  ‚îî –ó–∞—Ç—Ä–∞—Ç—ã: ${vm.monthly_cost}‚ÇΩ/–º–µ—Å\\n`;\n    message += `‚îÉ  ‚îî –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –°–†–û–ß–ù–û–ï –í–ú–ï–®–ê–¢–ï–õ–¨–°–¢–í–û\\n‚îÉ\\n`;\n  });\n  message += `\\n`;\n}\n\n// 2. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å\nif (critical.length > 0) {\n  message += `üî¥ –¢–†–ï–ë–£–ï–¢–°–Ø –î–ï–ô–°–¢–í–ò–ï (${critical.length}):\\n`;\n  critical.forEach(vm => {\n    message += `‚î£‚îÅ ${vm.vm_name}\\n`;\n    message += `‚îÉ  ‚îî –ü—Ä–æ—Å—Ç–æ–π: ${vm.inactivity_days} –¥–Ω–µ–π\\n`;\n    message += `‚îÉ  ‚îî –ó–∞—Ç—Ä–∞—Ç—ã: ${vm.monthly_cost}‚ÇΩ/–º–µ—Å\\n`;\n    message += `‚îÉ  ‚îî –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –£–¥–∞–ª–∏—Ç—å\\n‚îÉ\\n`;\n  });\n  message += `\\n`;\n}\n\n// 3. –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å\nif (high.length > 0) {\n  message += `üü† –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (${high.length}):\\n`;\n  high.forEach(vm => {\n    message += `‚î£‚îÅ ${vm.vm_name}\\n`;\n    message += `‚îÉ  ‚îî –ü—Ä–æ—Å—Ç–æ–π: ${vm.inactivity_days} –¥–Ω–µ–π\\n`;\n    message += `‚îÉ  ‚îî –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ${vm.usage_hours_week || 0}—á/–Ω–µ–¥–µ–ª—é\\n`;\n    message += `‚îÉ  ‚îî –ó–∞—Ç—Ä–∞—Ç—ã: ${vm.monthly_cost}‚ÇΩ/–º–µ—Å\\n`;\n    message += `‚îÉ  ‚îî –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ\\n‚îÉ\\n`;\n  });\n  message += `\\n`;\n}\n\n// 4. –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å\nif (medium.length > 0) {\n  message += `üü° –ú–û–ù–ò–¢–û–†–ò–ù–ì (${medium.length}):\\n`;\n  medium.forEach(vm => {\n    message += `‚îî‚îÅ ${vm.vm_name} (${vm.inactivity_days} –¥–Ω–µ–π –ø—Ä–æ—Å—Ç–æ—è)\\n`;\n  });\n  message += `\\n`;\n}\n\n// 5. –ù–æ—Ä–º–∞–ª—å–Ω—ã–µ –∏ –Ω–∏–∑–∫–∏–µ (–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ)\nconst normalLowCount = normal.length + low.length;\nif (normalLowCount > 0) {\n  message += `üü¢ –ê–ö–¢–ò–í–ù–û–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï (${normalLowCount}):\\n`;\n  normal.forEach(vm => {\n    message += `‚îî‚îÅ ${vm.vm_name} (${vm.inactivity_days} –¥–Ω–µ–π)\\n`;\n  });\n  low.forEach(vm => {\n    message += `‚îî‚îÅ ${vm.vm_name} (${vm.inactivity_days} –¥–Ω–µ–π)\\n`;\n  });\n  message += `\\n`;\n}\n\n// 6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏\nconst realTimeCount = realTimeClassification.active.length + \n                      realTimeClassification.recent.length + \n                      realTimeClassification.today.length;\n\nif (realTimeCount > 0) {\n  message += `üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò:\\n`;\n  \n  if (realTimeClassification.active.length > 0) {\n    message += `üü¢ –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ (${realTimeClassification.active.length}):\\n`;\n    realTimeClassification.active.forEach(vm => {\n      message += `‚îî‚îÅ ${vm.vm_name} (—Å–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω)\\n`;\n    });\n    message += `\\n`;\n  }\n  \n  if (realTimeClassification.recent.length > 0) {\n    message += `üü° –ù–µ–¥–∞–≤–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (${realTimeClassification.recent.length}):\\n`;\n    realTimeClassification.recent.forEach(vm => {\n      message += `‚îî‚îÅ ${vm.vm_name} (<15 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥)\\n`;\n    });\n    message += `\\n`;\n  }\n  \n  if (realTimeClassification.today.length > 0) {\n    message += `üîµ –ê–∫—Ç–∏–≤–Ω—ã —Å–µ–≥–æ–¥–Ω—è (${realTimeClassification.today.length}):\\n`;\n    realTimeClassification.today.forEach(vm => {\n      message += `‚îî‚îÅ ${vm.vm_name} (${vm.inactivity_hours || '0.5'} —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥)\\n`;\n    });\n    message += `\\n`;\n  }\n}\n\n// 7. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∏—Ç–æ–≥–∏\nconst totalIdle = catastrophic.length + critical.length + high.length + medium.length;\nconst totalCritical = catastrophic.length + critical.length;\nconst totalActive = userVMs.length - totalIdle;\nconst potentialSaving = [...catastrophic, ...critical, ...high, ...medium]\n  .reduce((sum, vm) => sum + (vm.monthly_cost || 0), 0);\n\nmessage += `üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê:\\n`;\nmessage += `‚î£‚îÅ –í—Å–µ–≥–æ –í–ú: ${userVMs.length}\\n`;\nmessage += `‚î£‚îÅ –ê–∫—Ç–∏–≤–Ω—ã—Ö: ${totalActive}\\n`;\nmessage += `‚î£‚îÅ –ü—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏—Ö: ${totalIdle}\\n`;\nif (totalCritical > 0) {\n  message += `‚î£‚îÅ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö: ${totalCritical}\\n`;\n}\nmessage += `‚îó‚îÅ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è: ${potentialSaving.toLocaleString()}‚ÇΩ/–º–µ—Å\\n\\n`;\n\n// 8. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\nmessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\nif (totalIdle > 0) {\n  message += `üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:\\n`;\n  if (catastrophic.length > 0) {\n    message += `‚Ä¢ –°–†–û–ß–ù–û –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –í–ú —Å –ø–æ–º–µ—Ç–∫–æ–π ‚õî\\n`;\n  }\n  if (critical.length > 0 || high.length > 0) {\n    message += `‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /optimize –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞\\n`;\n  }\n  message += `‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∞—Ä—Ö–∏–≤–∞—Ü–∏—é —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –í–ú\\n`;\n} else {\n  message += `‚úÖ –í—Å–µ –í–ú –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ!\\n`;\n  message += `–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.`;\n}\n\n// 9. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏)\nif (realTimeClassification.active.length > 0) {\n  message += `\\n\\nüíª –°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω: ${realTimeClassification.active.length} –í–ú`;\n}\n\nreturn {\n  json: {\n    message,\n    chat_id: $('Webhook - Telegram Bot').item.json.message.chat.id,\n    idle_count: totalIdle,\n    critical_count: totalCritical,\n    potential_saving: potentialSaving,\n    stats: {\n      total: userVMs.length,\n      active: totalActive,\n      idle: totalIdle,\n      catastrophic: catastrophic.length,\n      critical: critical.length,\n      high: high.length,\n      medium: medium.length,\n      realTime: {\n        active: realTimeClassification.active.length,\n        recent: realTimeClassification.recent.length,\n        today: realTimeClassification.today.length\n      }\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2032,
        0
      ],
      "id": "bed67e04-c167-4823-b4ce-c9e4cd3c5479",
      "name": "Detect Idle VMs"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2240,
        0
      ],
      "id": "45f1b667-8fea-46e1-be0a-ccbc97b381b2",
      "name": "Send: Idle Report",
      "webhookId": "b0dd063d-12f5-4765-b025-f54802ffec12",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "content": "## –û–±—Ä–∞–±–æ—Ç—á–∏–∫: –ö–∞—Ç–∞–ª–æ–≥ –ü–û (/software_catalog)\n\n1. –ü—Ä–∏ –≤–≤–æ–¥–µ –∫–æ–º–∞–Ω–¥—ã `/softwarecatalog` (–∏–ª–∏ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ–π —Ñ–æ—Ä–º—ã –≤ regex) Command Router –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Ç–æ–∫ –≤ –≤–µ—Ç–∫—É –∫–∞—Ç–∞–ª–æ–≥–∞ –ü–û.\n1. –£–∑–µ–ª `Load Software Catalog` –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É **Software_Catalog** –∏–∑ Google Sheets\n1. –ü–æ—Å–ª–µ —á–µ–≥–æ `Add Context Info` –æ–±–æ–≥–∞—â–∞–µ—Ç —Å—ã—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–æ–π —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–æ—Å—Ç–∏).\n1. –ö–æ–¥–æ–≤—ã–π —É–∑–µ–ª `Format Catalog Message` –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ü–û –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å ID, –Ω–∞–∑–≤–∞–Ω–∏–µ–º, –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π, —Ü–µ–Ω–æ–π –∏ –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º\n1. –£–∑–µ–ª `Send: Software Catalog` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–º–µ—Å—Ç–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π, –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä–∞ –ü–û –≤ –∫–æ–º–∞–Ω–¥–µ `/createvm`.",
        "height": 512,
        "width": 1600,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        992,
        -2032
      ],
      "typeVersion": 1,
      "id": "f2634ec0-07b5-4f14-a45b-b1a3fed607fc",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "jsCode": "const software = $input.all();\n\nlet message = `üíø –ö–∞—Ç–∞–ª–æ–≥ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ–≥–æ –ü–û\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\n\nsoftware.forEach(sw => {\n  message += `${sw.json.software_id}. ${sw.json.name}\\n`;\n  message += `   üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${sw.json.category}\\n`;\n  message += `   üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${sw.json.cost_per_month}‚ÇΩ/–º–µ—Å\\n`;\n  message += `   ‚ö° –ù–∞–≥—Ä—É–∑–∫–∞: ${'‚ñì'.repeat(sw.json.resource_weight)}${'‚ñë'.repeat(5 - sw.json.resource_weight)} ${sw.json.resource_weight}/5\\n`;\n  message += `   üìù ${sw.json.description}\\n\\n`;\n});\n\nmessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\nmessage += `–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –í–ú —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ü–û:\\n`;\nmessage += `/create_vm [–Ω–æ–º–µ—Ä–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é]\\n`;\nmessage += `–ù–∞–ø—Ä–∏–º–µ—Ä: /create_vm 1,3,5`;\n\nreturn {\n  json: {\n    message,\n    chat_id: $('Webhook - Telegram Bot').item.json.message.chat.id\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1936,
        -1744
      ],
      "id": "6d49c7ad-d88c-40b1-9aa2-b6cc8901da94",
      "name": "Format Catalog Message"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2208,
        -1744
      ],
      "id": "61ba462e-9b47-483b-acbf-90e46bcd18d9",
      "name": "Send: Software Catalog",
      "webhookId": "8eee79df-63c9-4821-b741-ac1101f76c79",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_id }}",
        "text": "=üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ POSASPR Helper!\n\n–≠—Ç–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ –º–∞—à–∏–Ω–∞–º–∏ —Å –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–º –ü–û.\n\nüìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n\n‚ûï /createvm [ID_–ü–û]\n   –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É\n   –ü—Ä–∏–º–µ—Ä: /createvm 1,3,5\n   –ë–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ - —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –ü–û\n\nüìä /myresources\n   –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n\nü§ñ /optimize\n   AI-–∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏\n\nüîç /checkidle\n   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏–µ –í–ú\n\nüíø /softwarecatalog\n   –ö–∞—Ç–∞–ª–æ–≥ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –ü–û\n\nüë§ /register\n   –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ (–Ω–∞ –≤—Å—è–∫–∏–π –ø–æ–∂–∞—Ä–Ω—ã–π)\n\n‚ùì /help\n   –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí° –ù–∞—á–Ω–∏—Ç–µ —Å /softwarecatalog",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -448,
        -1088
      ],
      "id": "83bbbcf8-4e25-4813-b73c-9d5a96c048ff",
      "name": "Send: Help",
      "webhookId": "89600108-b8ac-4022-965d-b37f38555fe3",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_id }}",
        "text": "=‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -448,
        -880
      ],
      "id": "522f7233-9435-4afe-8f00-84ef6c1e7a9c",
      "name": "Send: Unknown Command",
      "webhookId": "5c15bd88-23b4-4035-8e67-1920978b1007",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "messages": {
          "messageValues": [
            {
              "message": "=–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ IT-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö –∏ –¥–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.\n\n–í–ê–ñ–ù–û: –¢–≤–æ–π –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º Markdown. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª–∞:\n- –ó–∞–≥–æ–ª–æ–≤–∫–∏: **üóëÔ∏è –£–¥–∞–ª–∏—Ç—å** (–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç + —ç–º–æ–¥–∑–∏, –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ##)\n- –ü—É–Ω–∫—Ç—ã —Å–ø–∏—Å–∫–∞: ‚Ä¢ –∏–ª–∏ -\n- –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç: **—Ç–µ–∫—Å—Ç**\n- –ö—É—Ä—Å–∏–≤: _—Ç–µ–∫—Å—Ç_\n- –ö–æ–¥: `—Ç–µ–∫—Å—Ç`\n\n–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:\n\n**üóëÔ∏è –£–¥–∞–ª–∏—Ç—å**\n\n‚Ä¢ **[vm_name]**: [–ø—Ä–∏—á–∏–Ω–∞]\n  üí∞ –≠–∫–æ–Ω–æ–º–∏—è: [—Å—É–º–º–∞]‚ÇΩ/–º–µ—Å\n\n(–ï—Å–ª–∏ –Ω–µ—Ç –í–ú –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: \"‚úÖ –í—Å–µ –í–ú –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ\")\n\n**üîÄ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å**\n\n‚Ä¢ **[vm_name1]** + **[vm_name2]**: [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]\n  üí∞ –≠–∫–æ–Ω–æ–º–∏—è: [—Å—É–º–º–∞]‚ÇΩ/–º–µ—Å\n\n(–ï—Å–ª–∏ –Ω–µ—Ç: \"‚ÑπÔ∏è –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è\")\n\n**üìâ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏**\n\n[–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –∏–ª–∏ \"‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è\"]\n\n**üí∞ –ò—Ç–æ–≥–æ**\n\n–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è: **[—Å—É–º–º–∞]‚ÇΩ/–º–µ—Å** ([–ø—Ä–æ—Ü–µ–Ω—Ç]%)\n\n–ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏, —Ñ—É—Ç–µ—Ä—ã –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –∫–æ–Ω—Ü–µ!"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        3808,
        -480
      ],
      "id": "722c261a-da63-4a6d-8b49-7fdf2016b60d",
      "name": "AI Optimization Analysis"
    },
    {
      "parameters": {
        "content": "## –û–±—Ä–∞–±–æ—Ç—á–∏–∫ 7: –î–µ—Ç–∞–ª–∏ –í–ú (/vm_details)\n\n1. –ö–æ–º–∞–Ω–¥–∞ `/vmdetails` –ø–æ–ø–∞–¥–∞–µ—Ç –∏–∑ Webhook - Telegram Bot —á–µ—Ä–µ–∑ Edit Fields –∏ Command Router –≤ –≤–µ—Ç–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ **2 - –ü—Ä–æ—Å–º–æ—Ç—Ä (–æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–µ)**, –≥–¥–µ –¥–∞–ª–µ–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —É–∑–ª–æ–º Switch View`. \n1. –£–∑–µ–ª `Get User for VM Details` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –µ–≥–æ –ø—Ä–∞–≤–∞—Ö –¥–æ—Å—Ç—É–ø–∞ –∫ –í–ú.\n1. –£–∑–µ–ª `Parse VM ID` —Ä–∞–∑–±–∏—Ä–∞–µ—Ç –≤–≤–µ–¥—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏–ª–∏ –∏–º—è –í–ú (–∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è).\n1. –£–∑–µ–ª `Valid VM ID?` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω; –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å—Ä–∞–∑—É –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `Send: VM Error` —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.\n1. –£–∑–µ–ª `Route VM Lookup` –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Ç–æ–∫ –ª–∏–±–æ –≤ `Get VM by ID`, –ª–∏–±–æ –≤ `Get VM by Name` (—Ç–∞–±–ª–∏—Ü–∞ **Virtual_Machines**), –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–≤—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.\n1. –£–∑–µ–ª `Merge VM Lookup` –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ ID/–∏–º–µ–Ω–∏ –≤ –µ–¥–∏–Ω—ã–π –æ–±—ä–µ–∫—Ç –í–ú, –∞ –∑–∞—Ç–µ–º Get Software Info for VM –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –ü–û –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ **Software_Catalog**.\n1. –£–∑–µ–ª `Format VM Details Message` —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –í–ú (—Ä–µ—Å—É—Ä—Å—ã, —Å—Ç–∞—Ç—É—Å, –ø—Ä–æ—Å—Ç–æ–π, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –ü–û, —Å—Ç–æ–∏–º–æ—Å—Ç—å) –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –µ–≥–æ –≤ `Send: VM Details` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram.",
        "height": 752,
        "width": 2176,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2624,
        -1744
      ],
      "typeVersion": 1,
      "id": "bf972a42-3c75-4fed-8aab-1a1d71f7be67",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "jsCode": "// –ü–∞—Ä—Å–∏–º –∫–æ–º–∞–Ω–¥—É: /vmdetails [vm_id –∏–ª–∏ vm_name]\nconst message = $('Webhook - Telegram Bot').item.json.message.text;\nconst parts = message.trim().split(' ');\n\nlet vmId = null;\nlet vmName = null;\n\nif (parts.length > 1) {\n  const input = parts[1].trim();\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–≤–µ–¥–µ–Ω–æ: —á–∏—Å–ª–æ –∏–ª–∏ –∏–º—è\n  if (/^\\d+$/.test(input)) {\n    // –í–≤–µ–¥—ë–Ω —á–∏—Å–ª–æ–≤–æ–π ID\n    vmId = parseInt(input);\n  } else if (input.startsWith('VM-')) {\n    // –í–≤–µ–¥–µ–Ω–æ –∏–º—è –í–ú\n    vmName = input;\n  } else {\n    // –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç\n    return {\n      json: {\n        error: true,\n        message: `‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: \"${input}\"\n\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /vmdetails [vm_id –∏–ª–∏ vm_name]\n–ü—Ä–∏–º–µ—Ä—ã:\n  /vmdetails 1733158234567\n  /vmdetails VM-526-743610-ANS\n\n–£–∑–Ω–∞—Ç—å –Ω–æ–º–µ—Ä–∞ –í–ú: /myresources`\n      }\n    };\n  }\n}\n\n// –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ\nif (!vmId && !vmName) {\n  return {\n    json: {\n      error: false,\n      help: true,\n      message: `üí° –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ –∏–º—è –í–ú –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π\n\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /vmdetails [vm_id –∏–ª–∏ vm_name]\n–ü—Ä–∏–º–µ—Ä—ã:\n  /vmdetails 1733158234567\n  /vmdetails VM-526-743610-ANS\n\n–£–∑–Ω–∞—Ç—å –Ω–æ–º–µ—Ä–∞ –í–ú: /myresources`\n    }\n  };\n}\n\nreturn {\n  json: {\n    vm_id: vmId,\n    vm_name: vmName,\n    user_id: $input.first().json.user_id\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3248,
        -1328
      ],
      "id": "63979e02-ffed-41ff-8456-b5271ed0e00e",
      "name": "Parse VM ID"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "27b80a8a-d4ba-4e6c-9234-6e555df1374f",
              "leftValue": "={{ $json.error === undefined || $json.error === false }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3456,
        -1328
      ],
      "id": "b782ebaa-b0ad-477a-a7b3-717bbf4e2d46",
      "name": "Valid VM ID?"
    },
    {
      "parameters": {
        "jsCode": "// 1. –ü–û–õ–£–ß–ê–ï–ú –î–ê–ù–ù–´–• –í–ú (–∏–∑ —É–∑–ª–∞ Get VM by NameID)\n// –ú—ã –Ω–µ –º–æ–∂–µ–º –±—Ä–∞—Ç—å $input.first(), –ø–æ—Ç–æ–º—É —á—Ç–æ $input - —ç—Ç–æ –∫–∞—Ç–∞–ª–æ–≥ –ü–û!\n// –ë–µ—Ä–µ–º —Å—Ç—Ä–æ–≥–æ –∏–∑ —É–∑–ª–∞ —Å –í–ú.\nconst vmNode = $('Get VM by NameID').first(); \n\nif (!vmNode || !vmNode.json || !vmNode.json.vm_id) {\n  return {\n    json: {\n      error: true,\n      message: \"‚ùå –û—à–∏–±–∫–∞: –î–∞–Ω–Ω—ã–µ –í–ú –ø–æ—Ç–µ—Ä—è–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤—è–∑–∏ —É–∑–ª–æ–≤.\",\n      chat_id: $('Webhook - Telegram Bot').first().json.message.chat.id\n    }\n  };\n}\n\nconst vm = vmNode.json;\n\n// 2. –ü–û–õ–£–ß–ê–ï–ú –ö–ê–¢–ê–õ–û–ì –ü–û (–∏–∑ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö —ç—Ç–æ–≥–æ —É–∑–ª–∞)\n// –¢–∞–∫ –∫–∞–∫ Load Software Catalog3 —Å—Ç–æ–∏—Ç –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ –Ω–∞–º–∏, $input.all() - —ç—Ç–æ –∏ –µ—Å—Ç—å –∫–∞—Ç–∞–ª–æ–≥.\nconst softwareCatalog = $input.all().map(item => item.json);\n\n// 3. –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï (–°–∞–º–∞—è –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å)\nlet softwareListText = \"–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ\";\n\nif (vm.software_installed) {\n  let ids = [];\n  \n  // –ü–∞—Ä—Å–∏–º –≤—Ö–æ–¥–Ω—ã–µ ID (–æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π \"[1,2]\", —Å—Ç—Ä–æ–∫–æ–π \"1,2\", —á–∏—Å–ª–æ–º –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–º)\n  if (Array.isArray(vm.software_installed)) {\n    ids = vm.software_installed;\n  } else if (typeof vm.software_installed === 'number') {\n    ids = [vm.software_installed];\n  } else if (typeof vm.software_installed === 'string') {\n    // –ü—Ä–æ–±—É–µ–º JSON\n    try {\n        const parsed = JSON.parse(vm.software_installed);\n        if (Array.isArray(parsed)) ids = parsed;\n        else ids = vm.software_installed.split(',').map(Number);\n    } catch (e) {\n        // –ï—Å–ª–∏ –Ω–µ JSON, —Ç–æ CSV\n        ids = vm.software_installed.split(',').map(s => parseInt(s.trim()));\n    }\n  }\n\n  // –§–∏–ª—å—Ç—Ä—É–µ–º NaN\n  ids = ids.filter(id => !isNaN(id));\n\n  if (ids.length > 0) {\n    const names = ids.map(id => {\n      // –ü–†–ò–í–ï–î–ï–ù–ò–ï –¢–ò–ü–û–í! –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º ID –∫–∞–∫ —á–∏—Å–ª–∞.\n      // –í –∫–∞—Ç–∞–ª–æ–≥–µ software_id –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π \"1\", –∞ —É –Ω–∞—Å —á–∏—Å–ª–æ 1.\n      const sw = softwareCatalog.find(s => parseInt(s.software_id) === parseInt(id));\n      \n      if (sw) {\n          return `‚Ä¢ ${sw.name}`;\n      } else {\n          // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–∞, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–ø–æ—Ç–æ–º –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å ID)\n          return `‚Ä¢ Unknown (ID: ${id})`; \n      }\n    });\n    softwareListText = names.join('\\n   ');\n  }\n}\n\n// 4. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø\nconst drawBar = (val, max = 100) => {\n  const filled = Math.round((val / max) * 10); \n  return '‚ñì'.repeat(filled) + '‚ñë'.repeat(10 - filled);\n};\n\nlet statusIcon = '‚úÖ';\nif (vm.status === 'stopped') statusIcon = 'üî¥';\nif (vm.status === 'idle') statusIcon = '‚ö†Ô∏è';\n\nconst createdDate = vm.created_at ? new Date(vm.created_at).toISOString().split('T')[0] : 'N/A';\nconst lastActive = vm.last_active ? new Date(vm.last_active).toISOString().split('T')[0] : 'N/A';\nconst cost = vm.monthly_cost ? parseFloat(vm.monthly_cost).toLocaleString() : 0;\n\nconst message = `üñ•Ô∏è **–î–µ—Ç–∞–ª–∏ –í–ú: ${vm.vm_name}**\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüìÖ –°–æ–∑–¥–∞–Ω–∞: ${createdDate}\nüïê –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${lastActive}\n‚è±Ô∏è –ü—Ä–æ—Å—Ç–æ–π: ${vm.inactivity_days || 0} –¥–Ω–µ–π\n${statusIcon} –°—Ç–∞—Ç—É—Å: **${vm.status}**\n\nüìä **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**\nCPU: ${drawBar(vm.cpu_usage_avg || 0)} ${vm.cpu_usage_avg}%\nRAM: ${drawBar(vm.ram_usage_avg || 0)} ${vm.ram_usage_avg}%\n–ß–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é: ${vm.usage_hours_week || 0}\n\nüíª **–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –ü–û:**\n   ${softwareListText}\n\nüí∞ –ó–∞—Ç—Ä–∞—Ç—ã: **${cost}‚ÇΩ/–º–µ—Å**\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n${vm.status === 'idle' ? 'üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π (/checkidle)' : '‚úÖ –í–ú –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ'}`;\n\nreturn {\n  json: {\n    message: message,\n    chat_id: $('Webhook - Telegram Bot').first().json.message.chat.id,\n    error: false\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4224,
        -1424
      ],
      "id": "d9894173-1507-4f9d-bc70-f69a4f777799",
      "name": "Format VM Details Message"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4448,
        -1424
      ],
      "id": "069aafbb-5bed-49a9-90c6-2e6a12d0347c",
      "name": "Send: VM Details",
      "webhookId": "0360f2c3-23a0-4270-b12a-7eb1354128f3",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Edit Fields').item.json.chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3792,
        -1200
      ],
      "id": "8418d063-4247-4841-a9ac-d6c35452cf37",
      "name": "Send: VM Error",
      "webhookId": "65f931dc-c175-47df-a0e9-92b25afd9f8c",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Edit Fields').item.json.chat_id }}",
        "text": "=‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /register –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2560,
        -2720
      ],
      "id": "5acfb95b-455d-43ec-ba07-1e1a3d11973d",
      "name": "Send: Not Registered",
      "webhookId": "eec625cb-b3b2-4cd4-b8bc-f75db2cd9cae",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Edit Fields').item.json.chat_id }}",
        "text": "=‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ª–∏—Ü–µ–Ω–∑–∏–∏\n\n–¢–µ–∫—É—â–∏—Ö –í–ú: {{ $json.currentCount }}\n–õ–∏–º–∏—Ç: {{ $json.limit }}\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /optimize –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—é —Ä–µ—Å—É—Ä—Å–æ–≤",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3328,
        -2736
      ],
      "id": "37684bcc-ef48-4976-8ef2-6653208409e4",
      "name": "Send: Limit Exceeded",
      "webhookId": "49cfb367-0ba0-4470-b5c0-bcfb39858fde",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bbd1ba37-d64d-4440-8cb5-bfd33cd669c6",
              "name": "telegram_id",
              "value": "={{ $json.message.from.id }}",
              "type": "number"
            },
            {
              "id": "3b496a6c-af44-4080-9a0c-44309da9d6a5",
              "name": "text",
              "value": "={{ $json.message.text }}",
              "type": "string"
            },
            {
              "id": "efb3c752-6dbc-4fac-9e69-cf0f380b0364",
              "name": "username",
              "value": "={{ $json.message.from.first_name }} {{ $json.message.from.last_name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2848,
        -1936
      ],
      "id": "52091f17-1fc7-4067-8e7c-7ee923b05102",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7ac2e5db-7a62-46a6-8387-5388260370e8",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1600,
        -1008
      ],
      "id": "044e43af-0259-41eb-9894-0a35bdc751ee",
      "name": "User Found for Resources?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Edit Fields').item.json.chat_id }}",
        "text": "=‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /register –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\n",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1856,
        -880
      ],
      "id": "f0a69a15-53bf-4a0f-bb51-df3bfe33c294",
      "name": "Send: Not Registered for Resources",
      "webhookId": "6e6f072e-a190-4952-b3da-37cd6a534dc1",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "54a39efc-c498-47a6-ad04-980a28c47ec9",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3040,
        -464
      ],
      "id": "e03afe6d-5c8a-4fb5-88d4-fcccde57439e",
      "name": "User Found for Optimize?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Edit Fields').item.json.chat_id }}",
        "text": "=‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /register –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\n",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3280,
        -288
      ],
      "id": "eb22042c-661e-4e48-b8bc-c2d0c635d445",
      "name": "Send: Not Registered for Optimize",
      "webhookId": "babea0b8-b362-401b-9358-19162498f7d3",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "26e58526-1e6d-4d1b-8efc-8b69b40186ab",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1504,
        0
      ],
      "id": "fb9c8dfe-d815-43a4-ae28-97caefc2baf6",
      "name": "User Found for Idle Check?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Edit Fields').item.json.chat_id }}",
        "text": "=‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /register –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\n",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1776,
        128
      ],
      "id": "da1c44c8-5088-4cb6-83a9-8968dd28746a",
      "name": "Send: Not Registered for Idle Check",
      "webhookId": "483b1df8-f3bb-4572-a0f9-e3f84c4cb358",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Command Router').item.json.telegram_id }}",
        "text": "=‚úÖ Email —Å–æ—Ö—Ä–∞–Ω—ë–Ω!\n\n–¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:\n\n–ü—Ä–∏–º–µ—Ä: –û–û–û \"–†–æ–≥–∞ –∏ –ö–æ–ø—ã—Ç–∞\"",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1088,
        -3312
      ],
      "id": "33e2a4bc-ec4c-4de2-aa24-3d16653f32a5",
      "name": "Send Request Organization",
      "webhookId": "2120c152-e1ed-4e98-b3c1-8ce182720521",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "dda7c66e-1239-4d73-b40a-a1c9a3a214b1",
              "name": "telegram_id",
              "value": "={{ $json.telegram_id }}",
              "type": "string"
            },
            {
              "id": "f9beed1e-e2a2-4060-b8a6-043885068a21",
              "name": "menu_text",
              "value": "=üíø –í—ã–±–µ—Ä–∏—Ç–µ –ü–û –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:\n\n1. AutoCAD (CAD) - 3000‚ÇΩ/–º–µ—Å\n2. SolidWorks (CAD) - 3500‚ÇΩ/–º–µ—Å\n3. ANSYS (CAE) - 5000‚ÇΩ/–º–µ—Å\n4. CATIA (CAD/PLM) - 4000‚ÇΩ/–º–µ—Å\n5. MatLab (Programming) - 2500‚ÇΩ/–º–µ—Å\n6. Inventor (CAD) - 3200‚ÇΩ/–º–µ—Å\n7. –ö–æ–º–ø–∞—Å-3D (CAD) - 2000‚ÇΩ/–º–µ—Å\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä–∞ –ü–û —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é\n–ù–∞–ø—Ä–∏–º–µ—Ä: 1,3,5\n\n–ò–ª–∏ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã",
              "type": "string"
            },
            {
              "id": "badfcae4-7e1b-4814-87ec-98cf6c5d478b",
              "name": "user_id",
              "value": "={{ $('Can Create VM?').item.json.user_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3328,
        -3040
      ],
      "id": "979d66ef-d4d4-4a17-8504-77a21ad463b6",
      "name": "Prepare Software Menu",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "notesInFlow": false
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_id }}",
        "text": "=üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ $('Add New User').item.json.username }}!\n\n‚úÖ –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –í–∞—à Email, —Å –∫–æ—Ç–æ—Ä—ã–º –±—É–¥–µ—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–º –ü–û:\n",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1088,
        -3616
      ],
      "id": "f6c215de-f75b-4526-8fcd-12a23bff3065",
      "name": "Send Request Email",
      "webhookId": "fb079755-3fd3-4652-aa24-0c9929364d68",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "content": "## –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n\n1. –£–∑–µ–ª `Check User State` –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–∞–±–ª–∏—Ü–∞ **User_States**) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω—ã–π ¬´—à–∞–≥¬ª –¥–∏–∞–ª–æ–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –∏ —Ç.–ø.).\n1. –£–∑–µ–ª `Route by State` –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ (**4 - User Input** –∏–∑ Command Router) –≤ –Ω—É–∂–Ω—É—é –≤–µ—Ç–∫—É: –æ–±—ã—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –≤–≤–æ–¥ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤, —à–∞–≥–∏ –º–∞—Å—Ç–µ—Ä–∞ –∏ —Ç.–¥.\n1. –î–ª—è –Ω–æ–≤—ã—Ö –∏–ª–∏ –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ—Å–ª–µ `Send: Not Registered` –æ—Ç–¥–µ–ª—å–Ω–∞—è –≤–µ—Ç–∫–∞ –≤ Route by State —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω—É–∂–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–æ–∂–∏–¥–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏/–ø–æ—á—Ç—ã/–ª–∏—Ü–µ–Ω–∑–∏–∏¬ª) –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–∑–ª–æ–≤ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (Send: ...) –∏ –∫–æ–¥–æ–≤—ã—Ö —É–∑–ª–æ–≤ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—ã.\n1. –ù–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–¥–æ–≤—ã–µ —É–∑–ª—ã –æ–±–Ω–æ–≤–ª—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–µ—Ä–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π **User_States**), –∞ Route by State –ø–æ —ç—Ç–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é —Ä–µ—à–∞–µ—Ç, –∫–∞–∫–æ–π –≤–æ–ø—Ä–æ—Å –∑–∞–¥–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–º –∏ –∫–æ–≥–¥–∞ —Å—á–∏—Ç–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π.\n1. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ ¬´–æ–±—ã—á–Ω–æ–µ¬ª (–±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞), –∏ –¥–∞–ª—å—à–µ –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (`/createvm`, `/myresources`, `/optimize`, `/checkidle`, `/softwarecatalog`) —Ä–∞–±–æ—Ç–∞—é—Ç —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
        "height": 1568,
        "width": 2288
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -576,
        -4064
      ],
      "typeVersion": 1,
      "id": "26a95861-777c-4451-a1a3-7d00fc1d570a",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram\nconst telegramData = $('Webhook - Telegram Bot').item.json.message.from;\nconst chatId = $('Edit Fields').item.json.chatid;\n\n// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –Ω–∞ –æ—Å–Ω–æ–≤–µ timestamp + random\nconst newUserId = Math.floor(Math.random() * 1000);\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nconst firstName = telegramData.first_name || '';\nconst lastName = telegramData.last_name || '';\nconst fullName = lastName ? `${firstName} ${lastName}` : firstName;\nconst telegramUsername = telegramData.username || `user${telegramData.id}`;\n\n// –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nconst newUser = {\n  user_id: newUserId,\n  username: fullName,\n  email: `${telegramUsername}@telegram.user`,\n  organization: firstName,\n  license_type: 'basic',\n  license_limit: 3,\n  created_at: new Date().toISOString().split('T')[0],\n  telegram_id: telegramData.id.toString()\n};\n\nreturn {\n  json: newUser\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        96,
        -3616
      ],
      "id": "bbdeea5b-27fb-46f9-bcfb-84118dcc15d7",
      "name": "Generate Registration Data"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "524efa48-0de3-431c-95e7-c3fd7454961f",
              "leftValue": "={{ $json.telegram_id }}",
              "rightValue": "={{ $('Edit Fields').item.json.telegram_id }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {
          "ignoreCase": false
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -224,
        -3712
      ],
      "id": "d90202c0-a2d3-49a9-b2d9-380c16f6fc5e",
      "name": "Already Registered?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "17d5a8b1-6e75-4bce-af33-8a6b5968a94e",
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3120,
        -1920
      ],
      "id": "26d593c5-c4ac-406d-b6c5-de6e0c455f29",
      "name": "Has Message"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e535af2d-aef2-4ca3-a78a-875f1390765f",
                    "leftValue": "={{ $('Edit Fields').item.json.text }}",
                    "rightValue": "/softwarecatalog",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "–ö–∞—Ç–∞–ª–æ–≥ –ü–û"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d41b2f57-2360-451b-9581-734edde4171a",
                    "leftValue": "={{ $('Edit Fields').item.json.text }}",
                    "rightValue": "/vmdetails",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –í–ú"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Edit Fields').item.json.text }}",
                    "rightValue": "/myresources",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "56cbe9ef-c4cf-46ea-925d-a95795418f6f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "–ú–æ–∏ —Ä–µ—Å—É—Ä—Å—ã"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        112,
        -1760
      ],
      "id": "8945baf7-d9c1-4a6a-8028-e2d1eada9390",
      "name": "Switch View"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Edit Fields').item.json.text }}",
                    "rightValue": "/optimize",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "b6b91e10-d533-4c50-aaad-21bb698807af"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a5e034e5-121d-484b-8ebd-33064b2b6f1c",
                    "leftValue": "={{ $('Edit Fields').item.json.text }}",
                    "rightValue": "/checkidle",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Å—Ç–æ—è"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        144,
        -912
      ],
      "id": "73dd1f05-9f1e-4072-a765-148eb033db47",
      "name": "Switch Analyze"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "178a088d-9ae4-4527-8dc6-3eadce72c82f",
              "leftValue": "={{ $json.telegram_id }}",
              "rightValue": "={{ $('Is Start Command?').item.json.chat_id }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2272,
        -2176
      ],
      "id": "c932d57f-d3cf-408e-8509-d6633be7f365",
      "name": "User Registered for Start?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Edit Fields').item.json.chat_id }}",
        "text": "=üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ $('Edit Fields').item.json.username }}!\n\nüìä –í–∞—à–∞ –ª–∏—Ü–µ–Ω–∑–∏—è: {{ $('Check Registration for Start').first().json.license_type }}\nüíº –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: –í–ú –±—É–¥–µ—Ç –ø–æ–¥—Å—á–∏—Ç–∞–Ω–æ/{{ $('Check Registration for Start').first().json.license_limit }}\n\nüìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n\n‚ûï /createvm [ID_–ü–û]\n   –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É\n   –ü—Ä–∏–º–µ—Ä: /createvm 1,3,5\n\nüìä /myresources\n   –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n\nü§ñ /optimize\n   AI-–∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏\n\nüîç /checkidle\n   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏–µ –í–ú\n\nüíø /softwarecatalog\n   –ö–∞—Ç–∞–ª–æ–≥ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –ü–û\n\n‚ùì /help\n   –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–∏–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏!",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1968,
        -2288
      ],
      "id": "4f7fd8f5-6585-4bab-9bb0-288cc7e38b87",
      "name": "Send: Welcome (Registered)",
      "webhookId": "2df9641d-6340-4689-b5ea-cd0bcaf4bcfb",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c8fbe15d-2261-4264-95e3-c9f9c32cc06d",
              "leftValue": "={{ $json.text }}",
              "rightValue": "=/register",
              "operator": {
                "type": "string",
                "operation": "startsWith"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2272,
        -1728
      ],
      "id": "a8642bbe-2594-4d89-bd1b-b479ee608f1f",
      "name": "Is Register Command?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c91ce669-bc82-458b-ac28-c5591e9bf257",
              "leftValue": "={{ $('Edit Fields').item.json.chat_id }}",
              "rightValue": "={{ $('Is Register Command?').item.json.chat_id }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1744,
        -1712
      ],
      "id": "99119dc7-6bde-4e19-9a02-65b80d9bf6ca",
      "name": "User Registered for Commands?",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "content": "## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\n\n1. –õ—é–±–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–º –≤ `Edit Fields` –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ Command Router, –≥–¥–µ –∫–æ–º–∞–Ω–¥–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø–æ —Ç–∏–ø–∞–º (—Å–æ–∑–¥–∞–Ω–∏–µ –í–ú, –ø—Ä–æ—Å–º–æ—Ç—Ä, –∞–Ω–∞–ª–∏–∑, –ø–æ–º–æ—â—å –∏ —Ç.–ø.).\n1. –î–ª—è –≤–µ—Ç–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –í–ú –∫–æ–º–∞–Ω–¥–∞ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ —É–∑–µ–ª `Get User for VM Creation`, –∫–æ—Ç–æ—Ä—ã–π –∏—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ **Users** –ø–æ Telegram ID –∏ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—å (—Ç–∏–ø –ª–∏—Ü–µ–Ω–∑–∏–∏, –ª–∏–º–∏—Ç –í–ú –∏ —Ç.–¥.).\n1. –£–∑–µ–ª `User Registered?` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞–π–¥–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å; –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –ø–æ—Ç–æ–∫ —É—Ö–æ–¥–∏—Ç –≤ `Send: Not Registered`, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.\n1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω, –µ–≥–æ –¥–∞–Ω–Ω—ã–µ (user_id, license_type, license_limit –∏ —Ç.–ø.) –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–∞–ª–µ–µ –≤ `Get Existing VMs for User` –∏ `Check License Limit` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π (—Å–æ–∑–¥–∞–Ω–∏–µ –í–ú, –∞–Ω–∞–ª–∏–∑, –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ—Å—É—Ä—Å–æ–≤).\n1. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –¥—Ä—É–≥–∏—Ö –≤–µ—Ç–∫–∞—Ö (—Ä–µ—Å—É—Ä—Å—ã, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –ø—Ä–æ—Å—Ç–æ–π), –≥–¥–µ —É–∑–ª—ã `Get User for Resources`, `Get User for Optimize`, `Get User for Idle Check` –≤—ã–ø–æ–ª–Ω—è—é—Ç —Ä–æ–ª—å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–µ—Ä–µ–¥ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π.",
        "height": 1408,
        "width": 1936
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2976,
        -2512
      ],
      "typeVersion": 1,
      "id": "7ca0318b-e3e6-42f1-a2d4-956b49b6496f",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "chatId": "={{ $('Edit Fields').item.json.chat_id }}",
        "text": "=‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω\n\n–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.\n\n–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /register\n",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1472,
        -1440
      ],
      "id": "fa682c2d-68b9-4e94-a690-ac4ba2d6057f",
      "name": "Send: Please Register First",
      "webhookId": "37486563-5a97-4c19-a951-b8f4dca9c0b5",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.state }}",
                    "rightValue": "awaiting_email",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "427550c6-9bd1-4e19-a1ba-abe2238f9c65"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "–û–∂–∏–¥–∞–Ω–∏–µ Email"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b8267457-1161-4f4c-87f8-81ec580cabc5",
                    "leftValue": "={{ $json.state }}",
                    "rightValue": "awaiting_organization",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f30d0684-230d-45ee-9fb2-d94da9e6d15b",
                    "leftValue": "={{ $json.state }}",
                    "rightValue": "awaiting_license_count",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "–û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–∏—Ü–µ–Ω–∑–∏–π"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "bbc97e3a-2ff5-4538-9922-bf008749dc0a",
                    "leftValue": "={{ $json.state }}",
                    "rightValue": "awaiting_software_selection",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ü–û –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞"
            }
          ]
        },
        "options": {
          "fallbackOutput": "=–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å /register"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        320,
        -2944
      ],
      "id": "db7d9fb6-4307-44fe-be6f-dcf590fb3b0d",
      "name": "State Router"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ac38a90c-1028-4783-a794-a592e0eaefb4",
              "leftValue": "={{ $json.text }}",
              "rightValue": "/start",
              "operator": {
                "type": "string",
                "operation": "startsWith"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2656,
        -1936
      ],
      "id": "52d89942-1ae8-4fbd-b829-87e7e09795c5",
      "name": "Is Start Command?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Edit Fields').item.json.chat_id }}",
        "text": "=–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!\n\n–≠—Ç–æ –±–æ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–º –ü–û.\n\n–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.\n\n–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /register\n",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1968,
        -2080
      ],
      "id": "2f3315cb-4d5e-4d93-9306-e3568e9a3916",
      "name": "Send: Please Register",
      "webhookId": "dc8c1c64-8868-4578-8ae8-625b911c50e5",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_id }}",
        "text": "={{ $json.menu_text }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3824,
        -2896
      ],
      "id": "967cbaec-7583-4173-af3e-9e9c597275ef",
      "name": "Send Software Menu",
      "webhookId": "732b2add-2846-47f1-bbd6-3212047174ee",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json._source }}",
                    "rightValue": "createvm",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "b5d9fcc8-e32a-4006-8d3d-8d61ff60b4fd"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "–¥–ª—è /createvm"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1ee8e8ab-ac43-463e-a24c-4b8d17cc889a",
                    "leftValue": "={{ $json._source }}",
                    "rightValue": "softwarecatalog",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "–¥–ª—è /softwarecatalog"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1680,
        -1760
      ],
      "id": "bc790321-4683-49b7-b270-744418149a7b",
      "name": "Route Catalog Output"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∞\nconst catalogData = $input.all();\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∏\nlet source = 'unknown';\nlet stateInfo = null;\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º State Router\ntry {\n  const stateRouter = $('State Router');\n  if (stateRouter && stateRouter.isExecuted) {\n    const stateData = stateRouter.first().json;\n    source = 'createvm';\n    stateInfo = {\n      state: stateData.state,\n      telegram_id: stateData.telegramid,\n      username: stateData.username\n    };\n  }\n} catch (e) {\n  // State Router –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è\n}\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º Edit Fields –¥–ª—è /softwarecatalog\ntry {\n  const editFields = $('Edit Fields');\n  if (editFields && editFields.item.json.text.includes('softwarecatalog')) {\n    source = 'softwarecatalog';\n  }\n} catch (e) {\n  // –û—à–∏–±–∫–∞\n}\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º\nreturn catalogData.map(item => ({\n  json: {\n    ...item.json,\n    _source: source,\n    _stateInfo: stateInfo\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1392,
        -1760
      ],
      "id": "12dfb281-5c26-40bd-97ae-cd0b206ffafc",
      "name": "Add Context Info"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI\nconst aiResponse = $json.output || $json.text || $json.response || '';\n\n// –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ—Ç\nif (!aiResponse) {\n  return {\n    json: {\n      message: '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Ç AI',\n      chat_id: $('Build Optimization Prompt').first().json.chat_id\n    }\n  };\n}\n\n// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É—Ç–µ—Ä\nlet message = `ü§ñ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\nmessage += aiResponse;\nmessage += `\\n\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\nmessage += `üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\\n`;\nmessage += `/myresources - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ—Å—É—Ä—Å—ã\\n`;\nmessage += `/checkidle - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π`;\n\nreturn {\n  json: {\n    message,\n    chat_id: $('Build Optimization Prompt').first().json.chat_id\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4160,
        -480
      ],
      "id": "07ad8e24-1823-430a-8bdc-f9e2e9d03145",
      "name": "Add Footer to Message"
    },
    {
      "parameters": {
        "chatId": "={{ $('Command Router').item.json.telegram_id }}",
        "text": "=‚úÖ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!\n\n–¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω, –∫–æ—Ç–æ—Ä–æ–µ –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:\n\nüíº –¢–∞—Ä–∏—Ñ—ã:\n‚Ä¢ 3-9 –í–ú ‚Üí Basic (5000‚ÇΩ/–º–µ—Å)\n‚Ä¢ 10-49 –í–ú ‚Üí Standard (15000‚ÇΩ/–º–µ—Å)\n‚Ä¢ 50+ –í–ú ‚Üí Premium (40000‚ÇΩ/–º–µ—Å)\n\n–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 3 –¥–æ 999:\n",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1088,
        -3104
      ],
      "id": "4d761128-c825-456b-9ce2-8a5e1b061fe8",
      "name": "Send Request License Count",
      "webhookId": "d9fe8dce-bd8e-4073-b0e4-5fb52d739d71",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_id }}",
        "text": "=üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–Ω–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!\n\nüë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ $json.username }}\nüíº –õ–∏—Ü–µ–Ω–∑–∏—è: {{ $json.license_type }} \n\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n/myresources - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã\n/createvm - –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É\n/softwarecatalog - –ö–∞—Ç–∞–ª–æ–≥ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –ü–û",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        96,
        -3824
      ],
      "id": "ee1df14f-b92f-42f5-8f34-5c9f6b5a376d",
      "name": "Send: Already Registered",
      "webhookId": "71e0f814-f2f7-4dc2-a7b1-6cf4c971c294",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Command Router').first().json.telegram_id }}",
        "text": "=‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\nüë§ Email: {{ $('Check Registration for Commands').first().json.email }}\nüè¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è: {{ $('Check Registration for Commands').first().json.organization }}\nüíº –õ–∏—Ü–µ–Ω–∑–∏—è: {{ $('Check Registration for Commands').first().json.license_type }} –Ω–∞ {{ $('Update User with Limit').item.json.license_limit }} –í–ú\n\nüìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n/createvm - –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É\n/myresources - –ú–æ–∏ —Ä–µ—Å—É—Ä—Å—ã\n/help - –°–ø—Ä–∞–≤–∫–∞\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /createvm –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∞—à–µ–π –ø–µ—Ä–≤–æ–π –í–ú!\n",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1088,
        -2896
      ],
      "id": "26db6b7b-4791-4c79-9c25-f754c130b742",
      "name": "Send: Registration Finish",
      "webhookId": "6a6cf2d9-65af-4d5a-bbb8-ed0a737a7ade",
      "credentials": {
        "telegramApi": {
          "id": "DDex8oHA77ADeVpY",
          "name": "SmartLicenseUsageAnalyzer_bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, telegram_id, username, email, organization, \n       license_type, license_limit, registered_at\nFROM users \nWHERE user_id = {{ $json.user_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2976,
        -1328
      ],
      "id": "59e949c7-6339-4a58-bb01-b0ec11ee752d",
      "name": "Get User for VM Details",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "users",
          "mode": "list",
          "cachedResultName": "users"
        },
        "where": {
          "values": [
            {
              "column": "user_id",
              "value": "={{ $json.user_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2064,
        -2880
      ],
      "id": "61b98a87-f107-4a35-9de3-682d8c131614",
      "name": "Get User for VM Creation",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "virtual_machines",
          "mode": "list",
          "cachedResultName": "virtual_machines"
        },
        "where": {
          "values": [
            {
              "column": "vm_id",
              "value": "={{ $json.vm_id }}"
            },
            {
              "column": "vm_name",
              "value": "={{ $json.vm_name }}"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3808,
        -1424
      ],
      "id": "688c9daa-e2f3-46a7-a392-f794d85ecfd7",
      "name": "Get VM by NameID",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "virtual_machines",
          "mode": "list",
          "cachedResultName": "virtual_machines"
        },
        "where": {
          "values": [
            {
              "column": "user_id",
              "value": "={{ $json.user_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1856,
        -1104
      ],
      "id": "fcd657f6-fdc4-4f2d-b608-b8f98ad6b2ae",
      "name": "Get VMs for Resources",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "users",
          "mode": "list",
          "cachedResultName": "users"
        },
        "where": {
          "values": [
            {
              "column": "user_id",
              "value": "={{ $json.user_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2768,
        -400
      ],
      "id": "ede47811-9012-48fa-8e1f-1c917f62d145",
      "name": "Get User for Optimize",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  vm.*,\n  COALESCE((\n    SELECT jsonb_agg(to_jsonb(sc) ORDER BY sc.software_id)\n    FROM unnest(vm.software_installed) AS sid(software_id)\n    JOIN software_catalog sc\n      ON sc.software_id = sid.software_id\n  ), '[]'::jsonb) AS software_installed_details,\n  COALESCE((\n    SELECT array_agg(sc.name ORDER BY sc.name)\n    FROM unnest(vm.software_installed) AS sid(software_id)\n    JOIN software_catalog sc\n      ON sc.software_id = sid.software_id\n  ), ARRAY[]::text[]) AS software_installed_names\nFROM virtual_machines vm\nWHERE vm.user_id = {{ $json.user_id }};\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3280,
        -480
      ],
      "id": "0e6aea3c-3f78-4c63-889b-7489122963f0",
      "name": "Get VMs for Optimize",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM users WHERE user_id = {{ $('Switch Analyze').item.json.user_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1248,
        0
      ],
      "id": "d23dcf84-5baa-45fb-9348-3178cd4ae382",
      "name": "Get User for Idle Check",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM virtual_machines WHERE user_id = {{ $json.user_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1776,
        -96
      ],
      "id": "bcda25c0-10dd-48a9-b395-35375fe6cee6",
      "name": "Get VMs for Idle Check",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "software_catalog",
          "mode": "list",
          "cachedResultName": "software_catalog"
        },
        "sort": {
          "values": [
            {
              "column": "software_id"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1152,
        -1760
      ],
      "id": "6e820cb0-27e9-41aa-ab1d-cce583663b18",
      "name": "Load Software Catalog",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "users",
          "mode": "list",
          "cachedResultName": "users"
        },
        "where": {
          "values": [
            {
              "column": "telegram_id",
              "value": "={{ $json.telegram_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1984,
        -1712
      ],
      "id": "289cecdf-13c1-4c91-9216-53bb4327c03d",
      "name": "Check Registration for Commands",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "users",
          "mode": "list",
          "cachedResultName": "users"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "user_id": "={{ $json.user_id }}",
            "license_limit": "={{ $json.license_limit }}",
            "telegram_id": "={{ $json.telegram_id }}",
            "username": "={{ $json.username }}",
            "license_type": "={{ $json.license_type }}",
            "registered_at": "={{ $json.created_at }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "username",
              "displayName": "username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "full_name",
              "displayName": "full_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "organization",
              "displayName": "organization",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "license_type",
              "displayName": "license_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "license_limit",
              "displayName": "license_limit",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "registered_at",
              "displayName": "registered_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_id",
              "displayName": "telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        336,
        -3616
      ],
      "id": "96f03720-d6b1-4408-b746-ee79367e454a",
      "name": "Add New User",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE users \nSET license_limit = {{ $('Edit Fields').item.json.text }}\nWHERE user_id = {{ $json.user_id }}\nRETURNING user_id, license_limit;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        640,
        -2896
      ],
      "id": "2eb1fbf7-1f70-4080-8fa6-7fc4c2e915fe",
      "name": "Update User with Limit",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "virtual_machines",
          "mode": "list",
          "cachedResultName": "virtual_machines"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "alert_sent": true,
            "vm_id": "={{ $json.vm_id }}",
            "user_id": "={{ $json.user_id }}",
            "cpu_usage_avg": "={{ $json.cpu_usage_avg }}",
            "usage_hours_week": "={{ $json.usage_hours_week }}",
            "inactivity_days": "={{ $json.inactivity_days }}",
            "monthly_cost": "={{ $json.monthly_cost }}",
            "vm_name": "={{ $json.vm_name }}",
            "created_at": "={{ $json.created_at }}",
            "status": "={{ $json.status }}",
            "last_active": "={{ $json.last_active }}",
            "ram_usage_avg": "={{ $json.ram_usage_avg }}",
            "software_installed": "=[{{ $json.software_installed }}]"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "vm_id",
              "displayName": "vm_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "vm_name",
              "displayName": "vm_name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "software_installed",
              "displayName": "software_installed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_active",
              "displayName": "last_active",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "cpu_usage_avg",
              "displayName": "cpu_usage_avg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "ram_usage_avg",
              "displayName": "ram_usage_avg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "usage_hours_week",
              "displayName": "usage_hours_week",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "inactivity_days",
              "displayName": "inactivity_days",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "monthly_cost",
              "displayName": "monthly_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "alert_sent",
              "displayName": "alert_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3328,
        -2560
      ],
      "id": "b639fa0a-ddab-47fc-a557-557ff88ed76f",
      "name": "Add VM to DB",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "users",
          "mode": "list",
          "cachedResultName": "users"
        },
        "where": {
          "values": [
            {
              "column": "user_id",
              "value": "={{ $json.user_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1168,
        -1024
      ],
      "id": "863c103b-1f9e-42d8-9b92-b5b04803df07",
      "name": "Get User",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "software_catalog",
          "mode": "list",
          "cachedResultName": "software_catalog"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2560,
        -3008
      ],
      "id": "f22931fa-e8f6-47dd-a88d-71d815be4237",
      "name": "Load Software Catalog2",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=redis-state:{{ $json.user_id }}",
        "value": "={{\n  JSON.stringify({ \n    state: \"awaiting_email\", \n    user_id: null, \n    username: null, \n    timestamp: new Date().toISOString() \n    }) \n}}",
        "keyType": "string",
        "expire": true,
        "ttl": 3600
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        848,
        -3616
      ],
      "id": "b9c7a2b3-3c2a-412d-a102-98e0ded5158b",
      "name": "Set User State register",
      "credentials": {
        "redis": {
          "id": "k3rZiJXMKohxs4tn",
          "name": "Redis beget 47"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE users \nSET email = '{{ $('Edit Fields').item.json.text }}'\nWHERE telegram_id = {{ $('Command Router').item.json.telegram_id }}\nRETURNING user_id;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        640,
        -3312
      ],
      "id": "b8a13d8b-70b1-4349-b60d-d2228a25f857",
      "name": "Update User with Email",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "state",
        "key": "=redis-state:{{ $json.user_id }}",
        "keyType": "string",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -128,
        -2912
      ],
      "id": "9a082a1c-45e8-4e1c-a431-ef00f36e438a",
      "name": "Get Current State",
      "credentials": {
        "redis": {
          "id": "k3rZiJXMKohxs4tn",
          "name": "Redis beget 47"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE users \nSET organization = '{{ $('Webhook - Telegram Bot').first().json.message.text }}'\nWHERE user_id = {{ $json.user_id }}\nRETURNING user_id, organization;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        640,
        -3104
      ],
      "id": "1df04e0d-ecf1-4928-8110-2b29253514cb",
      "name": "Update Users with Org",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=redis-state:{{ $json.user_id }}",
        "value": "={{ \n  JSON.stringify({ \n  state: \"awaiting_organization\", \n  user_id: $('Update User with Email').first().json.user_id, \n  username: $('Update User with Email').first().json.username, \n  email: $json.text, \n  timestamp: new Date().toISOString() \n  }) \n}}",
        "expire": true,
        "ttl": 3600
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        848,
        -3312
      ],
      "id": "0e7e6b93-08fd-4f9a-b4a2-7239f5121733",
      "name": "Update State Email",
      "credentials": {
        "redis": {
          "id": "k3rZiJXMKohxs4tn",
          "name": "Redis beget 47"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=redis-state:{{ $json.user_id }}",
        "value": "={{\n  JSON.stringify({\n    state: \"awaiting_license_count\",\n    user_id: $('Update Users with Org').first().json.user_id,\n    organization: $('Update Users with Org').first().json.organization,\n    timestamp: new Date().toISOString()\n  })\n}}",
        "expire": true,
        "ttl": 3600
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        848,
        -3104
      ],
      "id": "0fce0751-2372-4f40-b2ef-f28da8d39c69",
      "name": "Update State Organization",
      "credentials": {
        "redis": {
          "id": "k3rZiJXMKohxs4tn",
          "name": "Redis beget 47"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=redis-state:{{ $json.user_id }}",
        "value": "={{\n  JSON.stringify({\n    state: \"awaiting_software\",\n    user_id: $json.user_id,\n    timestamp: new Date().toISOString()\n  })\n}}",
        "expire": true,
        "ttl": 3600
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        848,
        -2896
      ],
      "id": "a42d579f-78c3-47fc-826e-5bc198f962ff",
      "name": "Update State License",
      "credentials": {
        "redis": {
          "id": "k3rZiJXMKohxs4tn",
          "name": "Redis beget 47"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "==redis-state:{{ $json.user_id }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1296,
        -2896
      ],
      "id": "fe2ddb12-0669-40da-9c48-c83a74f6a57c",
      "name": "Clear User State",
      "credentials": {
        "redis": {
          "id": "k3rZiJXMKohxs4tn",
          "name": "Redis beget 47"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É–∑–ª–∞ (Redis)\nconst item = $input.first();\n\n// –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, null –∏–ª–∏ 'start')\nif (!item || !item.json || !item.json.state) {\n  return {\n    json: {\n      state: null,      // –°–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ—Ç\n      user_id: null,\n      full_data: {}     // –ü—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö\n    }\n  };\n}\n\nlet parsedData = {};\nlet currentState = null;\n\ntry {\n  // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä–æ–∫—É, –ø—Ä–∏—à–µ–¥—à—É—é –∏–∑ Redis\n  // item.json.state - —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ \"{\\\"state\\\":\\\"awaiting_email\\\",...}\"\n  const rawState = item.json.state;\n  \n  if (typeof rawState === 'string') {\n    parsedData = JSON.parse(rawState);\n  } else if (typeof rawState === 'object') {\n    parsedData = rawState;\n  }\n  \n  // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–∞–º–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è\n  currentState = parsedData.state || null;\n  \n} catch (error) {\n  console.log('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –∏–∑ Redis:', error);\n  currentState = null;\n}\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–∏—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è State Router\nreturn {\n  json: {\n    state: currentState,           // –°—Ç—Ä–æ–∫–∞ –¥–ª—è Switch (–Ω–∞–ø—Ä–∏–º–µ—Ä: \"awaiting_email\")\n    user_id: parsedData.user_id,   // ID —é–∑–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)\n    username: parsedData.username, // –ò–º—è (–µ—Å–ª–∏ –µ—Å—Ç—å)\n    full_data: parsedData          // –í–µ—Å—å –æ–±—ä–µ–∫—Ç –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–∑–∂–µ\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        112,
        -2912
      ],
      "id": "a443c44d-04b3-4b1d-806b-51fb29d378b5",
      "name": "Parse State"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=redis-state:{{ $json.user_id }}",
        "value": "={{ JSON.stringify({\n  state: \"awaiting_software_selection\",\n  user_id: $('Get User for VM Creation').item.json.user_id,\n  timestamp: new Date().toISOString()\n}) }}\n",
        "expire": true,
        "ttl": 3600
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        3568,
        -3040
      ],
      "id": "ef81ee38-8ad0-4f79-a89d-0c8c1fa2a08a",
      "name": "Set State: Awaiting Software",
      "credentials": {
        "redis": {
          "id": "k3rZiJXMKohxs4tn",
          "name": "Redis beget 47"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "software_catalog",
          "mode": "list",
          "cachedResultName": "software_catalog"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4016,
        -1424
      ],
      "id": "49ec2bcd-1198-468f-9f96-702f3c899822",
      "name": "Load Software Catalog3",
      "credentials": {
        "postgres": {
          "id": "uHdhvi0uS3Mpktwy",
          "name": "Postgres beget 31"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook - Telegram Bot": {
      "main": [
        [
          {
            "node": "Has Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Command Router": {
      "main": [
        [
          {
            "node": "Get Current State",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get User for VM Creation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch View",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch Analyze",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send: Help",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send: Unknown Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Registered?": {
      "main": [
        [
          {
            "node": "Load Software Catalog2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send: Not Registered",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check License Limit": {
      "main": [
        [
          {
            "node": "Can Create VM?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Can Create VM?": {
      "main": [
        [
          {
            "node": "Prepare Software Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send: Limit Exceeded",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create VM with Software": {
      "main": [
        [
          {
            "node": "Add VM to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Summary": {
      "main": [
        [
          {
            "node": "Send: Resources Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Optimization Analysis",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Build Optimization Prompt": {
      "main": [
        [
          {
            "node": "AI Optimization Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detect Idle VMs": {
      "main": [
        [
          {
            "node": "Send: Idle Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Catalog Message": {
      "main": [
        [
          {
            "node": "Send: Software Catalog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Optimization Analysis": {
      "main": [
        [
          {
            "node": "Add Footer to Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse VM ID": {
      "main": [
        [
          {
            "node": "Valid VM ID?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Valid VM ID?": {
      "main": [
        [
          {
            "node": "Get VM by NameID",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send: VM Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format VM Details Message": {
      "main": [
        [
          {
            "node": "Send: VM Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send: Limit Exceeded": {
      "main": [
        []
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Is Start Command?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Found for Resources?": {
      "main": [
        [
          {
            "node": "Get VMs for Resources",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send: Not Registered for Resources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Found for Optimize?": {
      "main": [
        [
          {
            "node": "Get VMs for Optimize",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send: Not Registered for Optimize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Found for Idle Check?": {
      "main": [
        [
          {
            "node": "Get VMs for Idle Check",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send: Not Registered for Idle Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Software Menu": {
      "main": [
        [
          {
            "node": "Set State: Awaiting Software",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Request Email": {
      "main": [
        []
      ]
    },
    "Generate Registration Data": {
      "main": [
        [
          {
            "node": "Add New User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Already Registered?": {
      "main": [
        [
          {
            "node": "Send: Already Registered",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Registration Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Message": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch View": {
      "main": [
        [
          {
            "node": "Load Software Catalog",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get User for VM Details",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Analyze": {
      "main": [
        [
          {
            "node": "Get User for Optimize",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get User for Idle Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Registered for Start?": {
      "main": [
        [
          {
            "node": "Send: Welcome (Registered)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send: Please Register",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Register Command?": {
      "main": [
        [
          {
            "node": "Already Registered?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Registration for Commands",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Registered for Commands?": {
      "main": [
        [
          {
            "node": "Command Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send: Please Register First",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "State Router": {
      "main": [
        [
          {
            "node": "Update User with Email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Users with Org",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update User with Limit",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Load Software Catalog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Start Command?": {
      "main": [
        [
          {
            "node": "User Registered for Start?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Register Command?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Software Menu": {
      "main": [
        []
      ]
    },
    "Route Catalog Output": {
      "main": [
        [
          {
            "node": "Create VM with Software",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Catalog Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Context Info": {
      "main": [
        [
          {
            "node": "Route Catalog Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Footer to Message": {
      "main": [
        [
          {
            "node": "Send: AI Recommendations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Request License Count": {
      "main": [
        []
      ]
    },
    "Send Request Organization": {
      "main": [
        []
      ]
    },
    "Get User for VM Details": {
      "main": [
        [
          {
            "node": "Parse VM ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User for VM Creation": {
      "main": [
        [
          {
            "node": "User Registered?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get VM by NameID": {
      "main": [
        [
          {
            "node": "Load Software Catalog3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get VMs for Resources": {
      "main": [
        [
          {
            "node": "Calculate Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User for Optimize": {
      "main": [
        [
          {
            "node": "User Found for Optimize?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get VMs for Optimize": {
      "main": [
        [
          {
            "node": "Build Optimization Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User for Idle Check": {
      "main": [
        [
          {
            "node": "User Found for Idle Check?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get VMs for Idle Check": {
      "main": [
        [
          {
            "node": "Detect Idle VMs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Software Catalog": {
      "main": [
        [
          {
            "node": "Add Context Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Registration for Commands": {
      "main": [
        [
          {
            "node": "User Registered for Commands?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add New User": {
      "main": [
        [
          {
            "node": "Set User State register",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update User with Limit": {
      "main": [
        [
          {
            "node": "Update State License",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add VM to DB": {
      "main": [
        [
          {
            "node": "Send: VM Created",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User": {
      "main": [
        [
          {
            "node": "User Found for Resources?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Software Catalog2": {
      "main": [
        [
          {
            "node": "Check License Limit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set User State register": {
      "main": [
        [
          {
            "node": "Send Request Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update User with Email": {
      "main": [
        [
          {
            "node": "Update State Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Current State": {
      "main": [
        [
          {
            "node": "Parse State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Users with Org": {
      "main": [
        [
          {
            "node": "Update State Organization",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update State Email": {
      "main": [
        [
          {
            "node": "Send Request Organization",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update State Organization": {
      "main": [
        [
          {
            "node": "Send Request License Count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update State License": {
      "main": [
        [
          {
            "node": "Send: Registration Finish",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send: Registration Finish": {
      "main": [
        [
          {
            "node": "Clear User State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse State": {
      "main": [
        [
          {
            "node": "State Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set State: Awaiting Software": {
      "main": [
        [
          {
            "node": "Send Software Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Software Catalog3": {
      "main": [
        [
          {
            "node": "Format VM Details Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "a1e6c6f9-0c98-41bb-b93b-24d174b5fe9e",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f4300700b5a89163b88ad6a908ff9e3076c705e8b03a3f40f03ff2f29f7e4289"
  },
  "id": "8fMPbkdJOZiJulZD",
  "tags": [
    {
      "updatedAt": "2026-01-01T10:05:42.794Z",
      "createdAt": "2026-01-01T10:05:42.794Z",
      "id": "FnoHHZ9X50FaY3Y2",
      "name": "redis"
    },
    {
      "updatedAt": "2026-01-01T10:05:39.508Z",
      "createdAt": "2026-01-01T10:05:39.508Z",
      "id": "hLmpjl8xP4ZIbj8N",
      "name": "postgres"
    },
    {
      "updatedAt": "2025-12-12T17:26:52.994Z",
      "createdAt": "2025-12-12T17:26:52.994Z",
      "id": "J09NNQhWt9FvC7x9",
      "name": "Telegram"
    }
  ]
}